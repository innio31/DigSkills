<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Impact Digital Academy</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c5aa0;
            --secondary: #ff6b35;
            --accent: #4caf50;
            --light: #f8f9fa;
            --dark: #343a40;
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
            --info: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: var(--primary);
            color: white;
            transition: all 0.3s;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover,
        .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--secondary);
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .content-area {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
        }

        /* Section Styles */
        .section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--light);
            padding-bottom: 15px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background: #e06e1d;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }

        .btn-outline:hover {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: var(--light);
            color: var(--primary);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Question Options */
        .option-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .option-label {
            width: 30px;
            font-weight: bold;
            color: var(--primary);
        }

        .correct-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: var(--secondary);
        }

        .file-upload i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }

        .file-upload.active {
            border-color: var(--success);
            background: #f8fff9;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .login-error {
            color: var(--danger);
            margin-top: 10px;
            text-align: center;
            display: none;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--secondary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .action-buttons {
                flex-direction: column;
            }

            .tabs {
                flex-direction: column;
            }
        }

        /* Password Toggle */
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
        }

        .password-input-container {
            position: relative;
        }

        .password-input-container .form-control {
            padding-right: 40px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 4px solid var(--primary);
        }

        .stat-card:nth-child(2) {
            border-left-color: var(--secondary);
        }

        .stat-card:nth-child(3) {
            border-left-color: var(--success);
        }

        .stat-card:nth-child(4) {
            border-left-color: var(--accent);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        /* Add these styles to your existing CSS */

        /* Responsive Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 800px;
            /* Minimum width for tables */
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            /* Maximum width for cells */
        }

        .data-table th {
            background: var(--light);
            color: var(--primary);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Specific column adjustments for exams table */
        .data-table th:nth-child(1),
        /* Title */
        .data-table td:nth-child(1) {
            min-width: 150px;
            max-width: 200px;
            white-space: normal;
        }

        .data-table th:nth-child(2),
        /* Program */
        .data-table td:nth-child(2),
        .data-table th:nth-child(3),
        /* Class */
        .data-table td:nth-child(3),
        .data-table th:nth-child(4),
        /* School */
        .data-table td:nth-child(4) {
            min-width: 120px;
            max-width: 150px;
        }

        .data-table th:nth-child(5),
        /* Duration */
        .data-table td:nth-child(5),
        .data-table th:nth-child(6),
        /* Questions */
        .data-table td:nth-child(6) {
            min-width: 80px;
            max-width: 100px;
            text-align: center;
        }

        .data-table th:nth-child(7),
        /* Available From */
        .data-table td:nth-child(7),
        .data-table th:nth-child(8),
        /* Available To */
        .data-table td:nth-child(8) {
            min-width: 120px;
            max-width: 140px;
        }

        .data-table th:nth-child(9),
        /* Status */
        .data-table td:nth-child(9) {
            min-width: 100px;
            max-width: 120px;
        }

        .data-table th:nth-child(10),
        /* Actions */
        .data-table td:nth-child(10) {
            min-width: 200px;
            max-width: 250px;
            white-space: nowrap;
        }

        /* Action buttons in tables */
        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        /* Questions table specific adjustments */
        #questionsTableBody td:nth-child(2) {
            /* Question text */
            min-width: 250px;
            max-width: 300px;
            white-space: normal;
        }

        #questionsTableBody td:nth-child(2) div {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Programs & Classes table adjustments */
        #programsTableBody td:nth-child(3),
        /* Description */
        #classesTableBody td:nth-child(7) {
            /* Description */
            min-width: 150px;
            max-width: 200px;
            white-space: normal;
        }

        /* User Management table adjustments */
        #instructorTableBody td:nth-child(3),
        /* Programs */
        #instructorTableBody td:nth-child(4),
        /* Classes */
        #studentTableBody td:nth-child(4),
        /* Class */
        #studentTableBody td:nth-child(5) {
            /* School */
            min-width: 100px;
            max-width: 120px;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 1200px) {
            .data-table {
                font-size: 0.9rem;
            }

            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 2px;
            }

            .action-btn {
                font-size: 0.7rem;
                padding: 3px 6px;
            }
        }

        @media (max-width: 768px) {
            .table-container {
                border-radius: 4px;
                margin-top: 15px;
            }

            .data-table {
                min-width: 600px;
                /* Smaller minimum width for mobile */
            }

            .data-table th,
            .data-table td {
                padding: 6px 8px;
                font-size: 0.85rem;
            }

            /* Hide less important columns on mobile */
            .data-table th:nth-child(4),
            /* School */
            .data-table td:nth-child(4),
            .data-table th:nth-child(7),
            /* Available From */
            .data-table td:nth-child(7),
            .data-table th:nth-child(8) {
                /* Available To */
                display: none;
            }

            /* Adjust action buttons for mobile */
            .action-buttons {
                flex-direction: column;
                min-width: 120px;
            }

            .action-btn {
                font-size: 0.65rem;
                padding: 2px 4px;
            }

            /* Questions table mobile adjustments */
            #questionsTableBody td:nth-child(3),
            /* Class */
            #questionsTableBody td:nth-child(4) {
                /* School */
                display: none;
            }
        }

        @media (max-width: 480px) {
            .table-container {
                margin-left: -15px;
                margin-right: -15px;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }

            .data-table {
                min-width: 100%;
                font-size: 0.8rem;
            }

            .data-table th,
            .data-table td {
                padding: 4px 6px;
            }

            /* Hide more columns on very small screens */
            .data-table th:nth-child(5),
            /* Duration */
            .data-table td:nth-child(5),
            .data-table th:nth-child(6) {
                /* Questions */
                display: none;
            }
        }

        /* Compact view for better mobile experience */
        .compact-view .data-table {
            font-size: 0.8rem;
        }

        .compact-view .action-btn {
            padding: 2px 4px;
            font-size: 0.7rem;
        }

        /* Status badges in tables */
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            text-align: center;
            min-width: 60px;
        }

        /* Tooltip for truncated text */
        .data-table td {
            position: relative;
        }

        .data-table td:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            display: block;
        }

        /* Scrollbar styling for table container */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Add a visual indicator that table is scrollable */
        .table-container {
            position: relative;
        }

        .table-container::after {
            content: '↔';
            position: absolute;
            right: 10px;
            top: 10px;
            color: #666;
            font-size: 0.8rem;
            opacity: 0.6;
        }

        @media (max-width: 768px) {
            .table-container::after {
                content: 'Scroll →';
                font-size: 0.7rem;
            }
        }
    </style>
</head>

<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal" style="display: flex;">
        <div class="login-container">
            <div class="login-header">
                <h2>Admin Login</h2>
                <p>Enter your admin credentials</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control"
                        placeholder="admin@impactdigitalacademy.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <div class="password-input-container">
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter password"
                            required>
                        <button type="button" class="password-toggle"
                            onclick="togglePasswordVisibility('loginPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                <div id="loginError" class="login-error" style="display: none;">
                    Invalid email or password
                </div>
            </form>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-laptop-code"></i>
                    <span>IDA Admin</span>
                </div>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </li>
                <li class="menu-item" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>User Management</span>
                </li>
                <li class="menu-item" data-section="programs">
                    <i class="fas fa-book"></i>
                    <span>Programs & Classes</span>
                </li>
                <li class="menu-item" data-section="questions">
                    <i class="fas fa-question-circle"></i>
                    <span>Questions Bank</span>
                </li>
                <li class="menu-item" data-section="exams">
                    <i class="fas fa-file-alt"></i>
                    <span>Assessments</span>
                </li>
                <!-- Add these new menu items -->
                <li class="menu-item" data-section="resources">
                    <i class="fas fa-file-download"></i>
                    <span>Resources</span>
                </li>
                <li class="menu-item" data-section="announcements">
                    <i class="fas fa-bullhorn"></i>
                    <span>Announcements</span>
                </li>
                <li class="menu-item" data-section="results">
                    <i class="fas fa-chart-bar"></i>
                    <span>Results & Analytics</span>
                </li>
                <li class="menu-item" data-section="settings">
                    <i class="fas fa-cogs"></i>
                    <span>Settings</span>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <h3>Admin Dashboard</h3>
                <div class="user-info">
                    <span id="adminName">Admin User</span>
                    <button class="btn btn-outline" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <div class="content-area">
                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-tachometer-alt"></i> Dashboard Overview
                        </h2>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 style="color: var(--primary);" id="totalStudents">0</h3>
                            <p>Total Students</p>
                        </div>
                        <div class="stat-card">
                            <h3 style="color: var(--secondary);" id="totalInstructors">0</h3>
                            <p>Total Instructors</p>
                        </div>
                        <div class="stat-card">
                            <h3 style="color: var(--success);" id="totalExams">0</h3>
                            <p>Active Assessments</p>
                        </div>
                        <div class="stat-card">
                            <h3 style="color: var(--accent);" id="totalQuestions">0</h3>
                            <p>Questions in Bank</p>
                        </div>
                    </div>

                    <div class="recent-activity"
                        style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">Recent Activity</h3>
                        <div id="recentActivity">
                            <div class="loading">Loading recent activity...</div>
                        </div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div id="users" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-users"></i> User Management
                        </h2>
                        <div>
                            <button class="btn btn-primary" id="addInstructorBtn">
                                <i class="fas fa-plus"></i> Add Instructor
                            </button>
                            <button class="btn btn-primary" id="addStudentBtn" style="margin-left: 10px;">
                                <i class="fas fa-plus"></i> Add Student
                            </button>
                            <button class="btn btn-warning" id="transferStudentsBtn" style="margin-left: 10px;">
                                <i class="fas fa-exchange-alt"></i> Transfer Students
                            </button>
                        </div>
                    </div>

                    <div class="tabs">
                        <button class="tab-btn active" data-tab="instructorTab">Instructor Accounts</button>
                        <button class="tab-btn" data-tab="studentTab">Student Accounts</button>
                    </div>

                    <div id="instructorTab" class="tab-content active">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Programs</th>
                                        <th>Classes</th>
                                        <th>School</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="instructorTableBody">
                                    <tr>
                                        <td colspan="7" class="loading">Loading instructor data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="studentTab" class="tab-content">
                        <div class="filters" style="margin-bottom: 20px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="filterStudentClass">Filter by Class</label>
                                    <select id="filterStudentClass" class="form-control">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="filterStudentSchool">Filter by School</label>
                                    <select id="filterStudentSchool" class="form-control">
                                        <option value="">All Schools</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-outline" id="clearStudentFilter" style="margin-top: 25px;">
                                        <i class="fas fa-times"></i> Clear Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th width="50px">
                                            <input type="checkbox" id="selectAllStudents"
                                                onchange="toggleSelectAllStudents(this)">
                                        </th>
                                        <th>Email</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>School</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentTableBody">
                                    <tr>
                                        <td colspan="7" class="loading">Loading student data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Programs & Classes Section -->
                <div id="programs" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-book"></i> Programs & Classes Management
                        </h2>
                        <div>
                            <button class="btn btn-primary" id="addProgramBtn">
                                <i class="fas fa-plus"></i> Add Program
                            </button>
                            <button class="btn btn-primary" id="addClassBtn" style="margin-left: 10px;">
                                <i class="fas fa-plus"></i> Add Class
                            </button>
                            <button class="btn btn-success" id="assignInstructorBtn" style="margin-left: 10px;">
                                <i class="fas fa-user-plus"></i> Assign Instructor
                            </button>
                        </div>
                    </div>

                    <div class="tabs">
                        <button class="tab-btn active" data-tab="programsTab">Programs</button>
                        <button class="tab-btn" data-tab="classesTab">Classes</button>
                    </div>

                    <div id="programsTab" class="tab-content active">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Program Name</th>
                                        <th>Program Code</th>
                                        <th>Description</th>
                                        <th>Assigned Instructors</th>
                                        <th>School</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="programsTableBody">
                                    <tr>
                                        <td colspan="7" class="loading">Loading programs data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="classesTab" class="tab-content">
                        <div class="filters" style="margin-bottom: 20px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="filterClassLevel">Filter by Level</label>
                                    <select id="filterClassLevel" class="form-control">
                                        <option value="">All Levels</option>
                                        <option value="beginner">Beginner</option>
                                        <option value="intermediate">Intermediate</option>
                                        <option value="advanced">Advanced</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="filterClassSchool">Filter by School</label>
                                    <select id="filterClassSchool" class="form-control">
                                        <option value="">All Schools</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-outline" id="clearClassFilter" style="margin-top: 25px;">
                                        <i class="fas fa-times"></i> Clear Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Class Name</th>
                                        <th>Class Code</th>
                                        <th>Level</th>
                                        <th>Student Count</th>
                                        <th>Instructor</th>
                                        <th>School</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="classesTableBody">
                                    <tr>
                                        <td colspan="8" class="loading">Loading classes data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Questions Bank Section -->
                <div id="questions" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-question-circle"></i> Questions Bank
                        </h2>
                        <div>
                            <button class="btn btn-primary" id="addQuestionBtn">
                                <i class="fas fa-plus"></i> Add Question
                            </button>
                            <button class="btn btn-success" id="bulkUploadBtn" style="margin-left: 10px;">
                                <i class="fas fa-upload"></i> Bulk Upload
                            </button>
                        </div>
                    </div>

                    <div class="filters" style="margin-bottom: 20px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="filterProgram">Filter by Program</label>
                                <select id="filterProgram" class="form-control">
                                    <option value="">All Programs</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filterClass">Filter by Class</label>
                                <select id="filterClass" class="form-control">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filterSchool">Filter by School</label>
                                <select id="filterSchool" class="form-control">
                                    <option value="">All Schools</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Program</th>
                                    <th>Class</th>
                                    <th>School</th>
                                    <th>Marks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="questionsTableBody">
                                <tr>
                                    <td colspan="6" class="loading">Loading questions data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Assessments Section -->
                <div id="exams" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-file-alt"></i> Assessments Management
                        </h2>
                        <button class="btn btn-primary" id="createExamBtn">
                            <i class="fas fa-plus"></i> Create Assessment
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Assessment Title</th>
                                    <th>Program</th>
                                    <th>Class</th>
                                    <th>School</th>
                                    <th>Duration</th>
                                    <th>Questions</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="examsTableBody">
                                <tr>
                                    <td colspan="8" class="loading">Loading assessments data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Resources Section -->
                <div id="resources" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-file-download"></i> Learning Resources
                        </h2>
                        <button class="btn btn-primary" id="addResourceBtn">
                            <i class="fas fa-plus"></i> Add Resource
                        </button>
                    </div>

                    <div class="filters" style="margin-bottom: 20px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="filterResourceProgram">Filter by Program</label>
                                <select id="filterResourceProgram" class="form-control">
                                    <option value="">All Programs</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filterResourceClass">Filter by Class</label>
                                <select id="filterResourceClass" class="form-control">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filterResourceType">Filter by Type</label>
                                <select id="filterResourceType" class="form-control">
                                    <option value="">All Types</option>
                                    <option value="pdf">PDF</option>
                                    <option value="video">Video</option>
                                    <option value="document">Document</option>
                                    <option value="presentation">Presentation</option>
                                    <option value="link">External Link</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Program</th>
                                    <th>Class</th>
                                    <th>Type</th>
                                    <th>File Size</th>
                                    <th>Upload Date</th>
                                    <th>Downloads</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resourcesTableBody">
                                <tr>
                                    <td colspan="9" class="loading">Loading resources...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Announcements Section -->
                <div id="announcements" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-bullhorn"></i> Announcements
                        </h2>
                        <button class="btn btn-primary" id="addAnnouncementBtn">
                            <i class="fas fa-plus"></i> Create Announcement
                        </button>
                    </div>

                    <div class="filters" style="margin-bottom: 20px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="filterAnnouncementProgram">Filter by Program</label>
                                <select id="filterAnnouncementProgram" class="form-control">
                                    <option value="">All Programs</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filterAnnouncementClass">Filter by Class</label>
                                <select id="filterAnnouncementClass" class="form-control">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filterAnnouncementStatus">Filter by Status</label>
                                <select id="filterAnnouncementStatus" class="form-control">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="expired">Expired</option>
                                    <option value="draft">Draft</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="announcements-grid" style="display: grid; gap: 20px;">
                        <!-- Announcements will be loaded here dynamically -->
                        <div id="announcementsContainer" class="loading">
                            Loading announcements...
                        </div>
                    </div>
                </div>

                <!-- Results & Analytics Section -->
                <div id="results" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-chart-bar"></i> Results & Analytics
                        </h2>
                    </div>

                    <div class="filters" style="margin-bottom: 20px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="resultsExam">Select Assessment</label>
                                <select id="resultsExam" class="form-control">
                                    <option value="">Select Assessment</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="resultsClass">Select Class</label>
                                <select id="resultsClass" class="form-control">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="resultsSchool">Select School</label>
                                <select id="resultsSchool" class="form-control">
                                    <option value="">All Schools</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" style="margin-top: 25px;" id="generateReportBtn">
                                    <i class="fas fa-chart-bar"></i> Generate Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="resultsContent">
                        <div class="chart-container">
                            <h3 class="chart-title">Performance Overview</h3>
                            <div id="performanceChart"
                                style="height: 300px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #666;">
                                Select an assessment to view performance chart
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Email</th>
                                        <th>Score</th>
                                        <th>Percentage</th>
                                        <th>Grade</th>
                                        <th>Time Spent</th>
                                        <th>Submitted</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 20px;">Select an assessment
                                            to view results</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings" class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-cogs"></i> System Settings
                        </h2>
                    </div>

                    <div class="tabs">
                        <button class="tab-btn active" data-tab="generalSettings">General</button>
                        <button class="tab-btn" data-tab="gradingSettings">Grading System</button>
                        <button class="tab-btn" data-tab="schoolSettings">Schools</button>
                    </div>

                    <div id="generalSettings" class="tab-content active">
                        <form id="generalSettingsForm">
                            <div class="form-group">
                                <label for="academyName">Academy Name</label>
                                <input type="text" id="academyName" class="form-control" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="academicYear">Academic Year</label>
                                    <input type="text" id="academicYear" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="academicTerm">Academic Term</label>
                                    <select id="academicTerm" class="form-control" required>
                                        <option value="First Term">First Term</option>
                                        <option value="Second Term">Second Term</option>
                                        <option value="Third Term">Third Term</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Save General Settings</button>
                        </form>
                    </div>

                    <div id="gradingSettings" class="tab-content">
                        <form id="gradingSettingsForm">
                            <div class="form-group">
                                <label>Grading System</label>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="gradeAMin">Grade A (Min %)</label>
                                        <input type="number" id="gradeAMin" class="form-control" min="0" max="100"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label for="gradeBMin">Grade B (Min %)</label>
                                        <input type="number" id="gradeBMin" class="form-control" min="0" max="100"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label for="gradeCMin">Grade C (Min %)</label>
                                        <input type="number" id="gradeCMin" class="form-control" min="0" max="100"
                                            required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="gradeDMin">Grade D (Min %)</label>
                                        <input type="number" id="gradeDMin" class="form-control" min="0" max="100"
                                            required>
                                    </div>
                                    <div class="form-group">
                                        <label for="gradeFMin">Grade F (Min %)</label>
                                        <input type="number" id="gradeFMin" class="form-control" min="0" max="100"
                                            required>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Grading System</button>
                        </form>
                    </div>

                    <div id="schoolSettings" class="tab-content">
                        <div class="form-group">
                            <label>Manage Schools</label>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>School Name</th>
                                            <th>Code</th>
                                            <th>Address</th>
                                            <th>Contact</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="schoolsTableBody">
                                        <tr>
                                            <td colspan="6" class="loading">Loading schools data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="addSchoolBtn">
                            <i class="fas fa-plus"></i> Add School
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- All Modals -->
    <!-- Add Instructor Modal -->
    <div id="addInstructorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Instructor Account</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addInstructorForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="instructorFirstName">First Name</label>
                            <input type="text" id="instructorFirstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="instructorLastName">Last Name</label>
                            <input type="text" id="instructorLastName" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="instructorEmail">Email</label>
                        <input type="email" id="instructorEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="instructorPassword">Password</label>
                        <div class="password-input-container">
                            <input type="password" id="instructorPassword" class="form-control" required>
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordVisibility('instructorPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="instructorSchool">School</label>
                        <select id="instructorSchool" class="form-control" required>
                            <option value="">Select School</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="instructorPrograms">Assigned Programs</label>
                        <select id="instructorPrograms" class="form-control" multiple style="height: 120px;">
                        </select>
                        <small style="color: #666;">Hold Ctrl/Cmd to select multiple programs</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelInstructorBtn">Cancel</button>
                <button class="btn btn-primary" id="saveInstructorBtn">Save Instructor</button>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Student Account</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="studentFirstName">First Name</label>
                            <input type="text" id="studentFirstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="studentLastName">Last Name</label>
                            <input type="text" id="studentLastName" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="studentEmail">Email</label>
                        <input type="email" id="studentEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="studentPassword">Password</label>
                        <div class="password-input-container">
                            <input type="password" id="studentPassword" class="form-control" required>
                            <button type="button" class="password-toggle"
                                onclick="togglePasswordVisibility('studentPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="studentSchool">School</label>
                        <select id="studentSchool" class="form-control" required>
                            <option value="">Select School</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="studentClass">Class</label>
                        <select id="studentClass" class="form-control" required>
                            <option value="">Select Class</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelStudentBtn">Cancel</button>
                <button class="btn btn-primary" id="saveStudentBtn">Save Student</button>
            </div>
        </div>
    </div>

    <!-- Add Program Modal -->
    <div id="addProgramModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Program</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addProgramForm">
                    <div class="form-group">
                        <label for="programName">Program Name</label>
                        <input type="text" id="programName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="programCode">Program Code</label>
                        <input type="text" id="programCode" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="programDescription">Description</label>
                        <textarea id="programDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="programSchool">School</label>
                        <select id="programSchool" class="form-control" required>
                            <option value="">Select School</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelProgramBtn">Cancel</button>
                <button class="btn btn-primary" id="saveProgramBtn">Save Program</button>
            </div>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div id="addClassModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Class</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addClassForm">
                    <div class="form-group">
                        <label for="className">Class Name</label>
                        <input type="text" id="className" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="classCode">Class Code</label>
                        <input type="text" id="classCode" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="classLevel">Level</label>
                        <select id="classLevel" class="form-control" required>
                            <option value="">Select Level</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="classProgram">Program</label>
                        <select id="classProgram" class="form-control" required>
                            <option value="">Select Program</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="classSchool">School</label>
                        <select id="classSchool" class="form-control" required>
                            <option value="">Select School</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="classDescription">Description</label>
                        <textarea id="classDescription" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelClassBtn">Cancel</button>
                <button class="btn btn-primary" id="saveClassBtn">Save Class</button>
            </div>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div id="addQuestionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Question</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addQuestionForm">
                    <div class="form-group">
                        <label for="questionText">Question</label>
                        <textarea id="questionText" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="questionProgram">Program</label>
                            <select id="questionProgram" class="form-control" required>
                                <option value="">Select Program</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="questionClass">Class</label>
                            <select id="questionClass" class="form-control" required>
                                <option value="">Select Class</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="questionSchool">School</label>
                        <select id="questionSchool" class="form-control" required>
                            <option value="">Select School</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="questionMarks">Marks</label>
                        <input type="number" id="questionMarks" class="form-control" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label>Options</label>
                        <div class="option-row">
                            <span class="option-label">A</span>
                            <input type="text" id="optionA" class="form-control" placeholder="Option A" required>
                        </div>
                        <div class="option-row">
                            <span class="option-label">B</span>
                            <input type="text" id="optionB" class="form-control" placeholder="Option B" required>
                        </div>
                        <div class="option-row">
                            <span class="option-label">C</span>
                            <input type="text" id="optionC" class="form-control" placeholder="Option C">
                        </div>
                        <div class="option-row">
                            <span class="option-label">D</span>
                            <input type="text" id="optionD" class="form-control" placeholder="Option D">
                        </div>
                        <div class="correct-option">
                            <label for="correctOption">Correct Option:</label>
                            <select id="correctOption" class="form-control" required>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelQuestionBtn">Cancel</button>
                <button class="btn btn-primary" id="saveQuestionBtn">Save Question</button>
            </div>
        </div>
    </div>

    <!-- Create Assessment Modal -->
    <div id="createExamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Assessment</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createExamForm">
                    <div class="form-group">
                        <label for="examTitle">Assessment Title</label>
                        <input type="text" id="examTitle" class="form-control" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="examProgram">Program</label>
                            <select id="examProgram" class="form-control" required>
                                <option value="">Select Program</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="examClass">Class</label>
                            <select id="examClass" class="form-control" required>
                                <option value="">Select Class</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="examSchool">School</label>
                        <select id="examSchool" class="form-control" required>
                            <option value="">Select School</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="examDuration">Duration (minutes)</label>
                            <input type="number" id="examDuration" class="form-control" min="5" value="60" required>
                        </div>
                        <div class="form-group">
                            <label for="examQuestions">Number of Questions</label>
                            <input type="number" id="examQuestions" class="form-control" min="1" value="10" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="examAvailableFrom">Available From</label>
                            <input type="datetime-local" id="examAvailableFrom" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="examAvailableTo">Available To</label>
                            <input type="datetime-local" id="examAvailableTo" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="examShuffleQuestions" style="width: auto;">
                                Shuffle Questions
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="examAllowMultipleAttempts" style="width: auto;">
                                Allow Multiple Attempts
                            </label>
                        </div>
                    </div>
                    <div class="form-group" id="maxAttemptsContainer" style="display: none;">
                        <label for="examMaxAttempts">Maximum Attempts</label>
                        <input type="number" id="examMaxAttempts" class="form-control" min="1" value="3">
                        <small style="color: #666;">Leave empty for unlimited attempts</small>
                    </div>
                    <div class="form-group">
                        <label for="examInstructions">Instructions</label>
                        <textarea id="examInstructions" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelExamBtn">Cancel</button>
                <button class="btn btn-primary" id="saveExamBtn">Create Assessment</button>
            </div>
        </div>
    </div>

    <!-- Add Resource Modal -->
    <div id="addResourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Learning Resource</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addResourceForm">
                    <div class="form-group">
                        <label for="resourceTitle">Resource Title</label>
                        <input type="text" id="resourceTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="resourceDescription">Description</label>
                        <textarea id="resourceDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="resourceProgram">Program</label>
                            <select id="resourceProgram" class="form-control" required>
                                <option value="">Select Program</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="resourceClass">Class</label>
                            <select id="resourceClass" class="form-control" required>
                                <option value="">Select Class</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="resourceType">Resource Type</label>
                        <select id="resourceType" class="form-control" required>
                            <option value="">Select Type</option>
                            <option value="pdf">PDF Document</option>
                            <option value="video">Video</option>
                            <option value="document">Word Document</option>
                            <option value="presentation">Presentation</option>
                            <option value="link">External Link</option>
                        </select>
                    </div>
                    <div class="form-group" id="resourceFileUpload">
                        <label for="resourceFile">Upload File</label>
                        <div class="file-upload" id="resourceFileUploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4>Upload Resource File</h4>
                            <p>Drag & drop your file here or click to browse</p>
                            <input type="file" id="resourceFile" accept=".pdf,.doc,.docx,.ppt,.pptx,.mp4,.avi,.mov"
                                style="display: none;">
                            <button type="button" class="btn btn-outline"
                                onclick="document.getElementById('resourceFile').click()">
                                <i class="fas fa-folder-open"></i> Browse Files
                            </button>
                        </div>
                        <div id="resourceFileInfo" style="display: none; margin-top: 10px;">
                            <strong>Selected file:</strong> <span id="resourceFileName"></span>
                            <br><small>Size: <span id="resourceFileSize"></span></small>
                        </div>
                    </div>
                    <div class="form-group" id="resourceLinkInput" style="display: none;">
                        <label for="resourceLink">External Link</label>
                        <input type="url" id="resourceLink" class="form-control" placeholder="https://...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelResourceBtn">Cancel</button>
                <button class="btn btn-primary" id="saveResourceBtn">Save Resource</button>
            </div>
        </div>
    </div>

    <!-- Add Announcement Modal -->
    <div id="addAnnouncementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Announcement</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addAnnouncementForm">
                    <div class="form-group">
                        <label for="announcementTitle">Title</label>
                        <input type="text" id="announcementTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="announcementMessage">Message</label>
                        <textarea id="announcementMessage" class="form-control" rows="5" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="announcementProgram">Program (Optional)</label>
                            <select id="announcementProgram" class="form-control">
                                <option value="">All Programs</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="announcementClass">Class (Optional)</label>
                            <select id="announcementClass" class="form-control">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="announcementStartDate">Start Date</label>
                            <input type="datetime-local" id="announcementStartDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="announcementEndDate">End Date</label>
                            <input type="datetime-local" id="announcementEndDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="announcementPriority">Priority</label>
                        <select id="announcementPriority" class="form-control">
                            <option value="low">Low</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="announcementNotifyStudents" style="width: auto;">
                            Send notification to students
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelAnnouncementBtn">Cancel</button>
                <button class="btn btn-primary" id="saveAnnouncementBtn">Publish Announcement</button>
            </div>
        </div>
    </div>

    <!-- Add School Modal -->
    <div id="addSchoolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New School</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addSchoolForm">
                    <div class="form-group">
                        <label for="schoolName">School Name</label>
                        <input type="text" id="schoolName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="schoolCode">School Code</label>
                        <input type="text" id="schoolCode" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="schoolAddress">Address</label>
                        <textarea id="schoolAddress" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="schoolPhone">Phone</label>
                            <input type="tel" id="schoolPhone" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="schoolEmail">Email</label>
                            <input type="email" id="schoolEmail" class="form-control">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelSchoolBtn">Cancel</button>
                <button class="btn btn-primary" id="saveSchoolBtn">Save School</button>
            </div>
        </div>
    </div>

    <!-- Transfer Students Modal -->
    <div id="transferStudentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Transfer Students</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Selected Students: <span id="selectedStudentsCount">0</span> student(s)</label>
                    <div id="selectedStudentsList"
                        style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 5px; border-radius: 4px;">
                        <p style="text-align: center; color: #666; margin: 0;">No students selected</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="transferToSchool">Transfer to School</label>
                    <select id="transferToSchool" class="form-control" required>
                        <option value="">Select Target School</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transferToClass">Transfer to Class</label>
                    <select id="transferToClass" class="form-control" required>
                        <option value="">Select Target Class</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transferEffectiveDate">Effective Date</label>
                    <input type="date" id="transferEffectiveDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="transferNotes">Notes (Optional)</label>
                    <textarea id="transferNotes" class="form-control" rows="3"
                        placeholder="Add any notes about this transfer..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelTransferBtn">Cancel</button>
                <button class="btn btn-warning" id="confirmTransferBtn">Transfer Students</button>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Bulk Upload Questions</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="file-upload" id="fileUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h4>Upload Excel File</h4>
                    <p>Drag & drop your Excel file here or click to browse</p>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" style="display: none;">
                    <button type="button" class="btn btn-outline"
                        onclick="document.getElementById('excelFile').click()">
                        <i class="fas fa-folder-open"></i> Browse Files
                    </button>
                </div>
                <div id="filePreview" style="display: none; margin-top: 20px;">
                    <h4>File Preview</h4>
                    <div class="table-container">
                        <table class="data-table" id="previewTable">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Option A</th>
                                    <th>Option B</th>
                                    <th>Option C</th>
                                    <th>Option D</th>
                                    <th>Correct</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label for="uploadProgram">Program</label>
                        <select id="uploadProgram" class="form-control" required>
                            <option value="">Select Program</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="uploadClass">Class</label>
                        <select id="uploadClass" class="form-control" required>
                            <option value="">Select Class</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="uploadSchool">School</label>
                        <select id="uploadSchool" class="form-control" required>
                            <option value="">Select School</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelUploadBtn">Cancel</button>
                <button class="btn btn-primary" id="processUploadBtn" disabled>Process Upload</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDU1ouyoXpOP0Gz_IFARGGAK0OAu0GZHlI",
            authDomain: "digskills-student-portal.firebaseapp.com",
            projectId: "digskills-student-portal",
            storageBucket: "digskills-student-portal.firebasestorage.app",
            messagingSenderId: "992494289117",
            appId: "1:992494289117:web:de1c682fb12ae9fae69b34",
            measurementId: "G-PKF5FPQN38"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();


        // Global variables
        let currentAdmin = null;
        let schools = [];
        let programs = [];
        let classes = [];
        let instructors = [];
        let students = [];
        let questions = [];
        let exams = [];
        let selectedStudents = new Set();
        let uploadedQuestions = [];
        let resources = [];
        let announcements = [];

        // DOM Elements
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const adminName = document.getElementById('adminName');
        const logoutBtn = document.getElementById('logoutBtn');
        const mainContainer = document.querySelector('.container');

        // Initialize application
        document.addEventListener('DOMContentLoaded', function () {
            initApp();
        });

        async function initApp() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('adminUser');
            if (savedUser) {
                currentAdmin = JSON.parse(savedUser);
                showAdminInterface();
                loadInitialData();
            }

            setupEventListeners();
            setupModalControls();
        }

        function setupEventListeners() {
            // Login form
            loginForm.addEventListener('submit', handleLogin);

            // Logout button
            logoutBtn.addEventListener('click', handleLogout);

            // Menu navigation
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function () {
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);

                    // Update active menu item
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });


            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');
                    const container = this.closest('.tabs').parentElement;

                    // Update active tab button
                    container.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // Show corresponding tab content
                    container.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // Add buttons
            document.getElementById('addInstructorBtn').addEventListener('click', () => {
                loadSchoolsAndPrograms().then(() => {
                    populateInstructorForm();
                    showModal('addInstructorModal');
                });
            });

            document.getElementById('addStudentBtn').addEventListener('click', () => {
                loadSchoolsAndClasses().then(() => {
                    populateStudentForm();
                    showModal('addStudentModal');
                });
            });

            document.getElementById('addProgramBtn').addEventListener('click', () => {
                loadSchools().then(() => {
                    populateProgramForm();
                    showModal('addProgramModal');
                });
            });

            document.getElementById('addClassBtn').addEventListener('click', () => {
                loadSchoolsAndPrograms().then(() => {
                    populateClassForm();
                    showModal('addClassModal');
                });
            });

            document.getElementById('addQuestionBtn').addEventListener('click', () => {
                loadSchoolsProgramsClasses().then(() => {
                    populateQuestionForm();
                    showModal('addQuestionModal');
                });
            });

            document.getElementById('addSchoolBtn').addEventListener('click', () => {
                showModal('addSchoolModal');
            });

            document.getElementById('transferStudentsBtn').addEventListener('click', showTransferModal);

            // Save buttons
            document.getElementById('saveInstructorBtn').addEventListener('click', saveInstructor);
            document.getElementById('saveStudentBtn').addEventListener('click', saveStudent);
            document.getElementById('saveProgramBtn').addEventListener('click', saveProgram);
            document.getElementById('saveClassBtn').addEventListener('click', saveClass);
            document.getElementById('saveQuestionBtn').addEventListener('click', saveQuestion);
            document.getElementById('saveSchoolBtn').addEventListener('click', saveSchool);
            document.getElementById('saveExamBtn').addEventListener('click', saveExam);
            document.getElementById('confirmTransferBtn').addEventListener('click', transferStudents);

            // Bulk upload
            document.getElementById('bulkUploadBtn').addEventListener('click', () => {
                loadSchoolsProgramsClasses().then(() => {
                    populateBulkUploadForm();
                    showModal('bulkUploadModal');
                });
            });

            document.getElementById('excelFile').addEventListener('change', handleFileUpload);
            document.getElementById('processUploadBtn').addEventListener('click', processBulkUpload);

            // File upload area
            const fileUploadArea = document.getElementById('fileUploadArea');
            fileUploadArea.addEventListener('dragover', handleDragOver);
            fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('active'));
            fileUploadArea.addEventListener('drop', handleFileDrop);
            fileUploadArea.addEventListener('click', () => document.getElementById('excelFile').click());

            // Generate report
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);

            // Settings forms
            document.getElementById('generalSettingsForm').addEventListener('submit', saveGeneralSettings);
            document.getElementById('gradingSettingsForm').addEventListener('submit', saveGradingSettings);
        }

        // New buttons
        document.getElementById('addResourceBtn').addEventListener('click', () => {
            loadSchoolsProgramsClasses().then(() => {
                populateResourceForm();
                showModal('addResourceModal');
            });
        });

        document.getElementById('addAnnouncementBtn').addEventListener('click', () => {
            loadSchoolsProgramsClasses().then(() => {
                populateAnnouncementForm();
                showModal('addAnnouncementModal');
            });
        });

        // Resource type change handler
        document.getElementById('resourceType').addEventListener('change', function () {
            const isLink = this.value === 'link';
            document.getElementById('resourceFileUpload').style.display = isLink ? 'none' : 'block';
            document.getElementById('resourceLinkInput').style.display = isLink ? 'block' : 'none';
        });

        // Resource file upload handler
        document.getElementById('resourceFile').addEventListener('change', handleResourceFileUpload);

        // Save buttons
        document.getElementById('saveResourceBtn').addEventListener('click', saveResource);
        document.getElementById('saveAnnouncementBtn').addEventListener('click', saveAnnouncement);

        // Cancel buttons
        document.getElementById('cancelResourceBtn').addEventListener('click', () => hideModal('addResourceModal'));
        document.getElementById('cancelAnnouncementBtn').addEventListener('click', () => hideModal('addAnnouncementModal'));


        function setupModalControls() {
            // Close buttons
            document.querySelectorAll('.modal-close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function () {
                    this.closest('.modal').classList.remove('active');
                });
            });

            // Cancel buttons
            document.querySelectorAll('[id$="Btn"]').forEach(btn => {
                if (btn.id.includes('cancel')) {
                    btn.addEventListener('click', function () {
                        this.closest('.modal').classList.remove('active');
                    });
                }
            });

            // Close modal when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
        }

        // Authentication
        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // Check if user exists in Firestore
                const usersSnapshot = await db.collection('users')
                    .where('email', '==', email)
                    .where('password', '==', password)
                    .where('role', '==', 'admin')
                    .get();

                if (!usersSnapshot.empty) {
                    const userDoc = usersSnapshot.docs[0];
                    currentAdmin = userDoc.data();
                    currentAdmin.userId = userDoc.id;

                    localStorage.setItem('adminUser', JSON.stringify(currentAdmin));
                    showAdminInterface();
                    loginModal.style.display = 'none';
                    loginError.style.display = 'none';
                    loadInitialData();
                    showNotification('Login successful!', 'success');
                } else {
                    loginError.style.display = 'block';
                    showNotification('Invalid email or password', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.style.display = 'block';
                showNotification('Login failed. Please try again.', 'error');
            }
        }

        function handleLogout() {
            currentAdmin = null;
            localStorage.removeItem('adminUser');
            loginModal.style.display = 'flex';
            mainContainer.style.display = 'none';
            document.getElementById('loginForm').reset();
            loginError.style.display = 'none';
            showNotification('Logged out successfully', 'info');
        }

        function showAdminInterface() {
            adminName.textContent = `${currentAdmin.firstName} ${currentAdmin.lastName}`;
            mainContainer.style.display = 'flex';
        }

        // Data Loading
        async function loadInitialData() {
            await loadSchools();
            await loadPrograms();
            await loadClasses();
            loadDashboardData();
        }

        async function loadSchools() {
            try {
                const schoolsSnapshot = await db.collection('schools').get();
                schools = schoolsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateSchoolDropdowns();
            } catch (error) {
                console.error('Error loading schools:', error);
            }
        }

        async function loadPrograms() {
            try {
                const programsSnapshot = await db.collection('programs').get();
                programs = programsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading programs:', error);
            }
        }

        async function loadClasses() {
            try {
                const classesSnapshot = await db.collection('classes').get();
                classes = classesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateClassDropdowns(); // Add this line
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        // Add this new function to populate class dropdowns
        function populateClassDropdowns() {
            const classSelects = document.querySelectorAll('select[id$="Class"]');
            classSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Class</option>';
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    select.appendChild(option);
                });
                if (currentValue) select.value = currentValue;
            });
        }

        async function loadSchoolsAndPrograms() {
            await Promise.all([loadSchools(), loadPrograms()]);
        }

        async function loadSchoolsAndClasses() {
            await Promise.all([loadSchools(), loadClasses()]);
        }

        async function loadSchoolsProgramsClasses() {
            await Promise.all([loadSchools(), loadPrograms(), loadClasses()]);
            populateExamForm();
        }

        // Add function to populate exam form dropdowns
        function populateExamForm() {
            const examProgram = document.getElementById('examProgram');
            const examClass = document.getElementById('examClass');
            const examSchool = document.getElementById('examSchool');

            // Store current values
            const currentProgram = examProgram.value;
            const currentClass = examClass.value;
            const currentSchool = examSchool.value;

            // Populate programs
            examProgram.innerHTML = '<option value="">Select Program</option>';
            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = program.name;
                examProgram.appendChild(option);
            });

            // Populate classes
            examClass.innerHTML = '<option value="">Select Class</option>';
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                examClass.appendChild(option);
            });

            // Populate schools
            examSchool.innerHTML = '<option value="">Select School</option>';
            schools.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.name;
                examSchool.appendChild(option);
            });

            // Restore previous selections if they exist
            if (currentProgram) examProgram.value = currentProgram;
            if (currentClass) examClass.value = currentClass;
            if (currentSchool) examSchool.value = currentSchool;
        }

        function populateSchoolDropdowns() {
            const schoolSelects = document.querySelectorAll('select[id$="School"]');
            schoolSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select School</option>';
                schools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.id;
                    option.textContent = school.name;
                    select.appendChild(option);
                });
                if (currentValue) select.value = currentValue;
            });
        }

        // Dashboard
        async function loadDashboardData() {
            try {
                const [
                    studentsSnapshot,
                    instructorsSnapshot,
                    examsSnapshot,
                    questionsSnapshot
                ] = await Promise.all([
                    db.collection('users').where('role', '==', 'student').get(),
                    db.collection('users').where('role', '==', 'instructor').get(),
                    db.collection('exams').where('status', '==', 'active').get(),
                    db.collection('questions').get()
                ]);

                document.getElementById('totalStudents').textContent = studentsSnapshot.size;
                document.getElementById('totalInstructors').textContent = instructorsSnapshot.size;
                document.getElementById('totalExams').textContent = examsSnapshot.size;
                document.getElementById('totalQuestions').textContent = questionsSnapshot.size;

                loadRecentActivity();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadRecentActivity() {
            const activityContainer = document.getElementById('recentActivity');

            try {
                const recentResults = await db.collection('results')
                    .orderBy('submittedAt', 'desc')
                    .limit(5)
                    .get();

                if (recentResults.empty) {
                    activityContainer.innerHTML = '<p style="text-align: center; color: #666;">No recent activity</p>';
                    return;
                }

                let activityHTML = '';
                for (const doc of recentResults.docs) {
                    const result = doc.data();
                    const studentDoc = await db.collection('users').doc(result.studentId).get();
                    const student = studentDoc.data();

                    activityHTML += `
                        <div style="padding: 10px; border-left: 4px solid var(--secondary); background: #f8f9fa; margin-bottom: 10px;">
                            <strong>Assessment Completed</strong>
                            <p style="margin: 5px 0 0 0; color: #666;">
                                ${student.firstName} ${student.lastName} scored ${result.score}/${result.totalQuestions} in ${result.examTitle}
                            </p>
                            <small style="color: #999;">${new Date(result.submittedAt?.toDate()).toLocaleString()}</small>
                        </div>
                    `;
                }

                activityContainer.innerHTML = activityHTML;
            } catch (error) {
                console.error('Error loading recent activity:', error);
                activityContainer.innerHTML = '<p style="text-align: center; color: #666;">Error loading recent activity</p>';
            }
        }

        // Section navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            // Load section-specific data
            switch (sectionId) {
                case 'users':
                    loadUsersData();
                    break;
                case 'programs':
                    loadProgramsData();
                    break;
                case 'questions':
                    loadQuestionsData();
                    break;
                case 'exams':
                    loadExamsData();
                    break;
                case 'results':
                    loadResultsData();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
            }
        }

        // User Management
        async function loadUsersData() {
            await loadInstructorsData();
            await loadStudentsData();
        }

        async function loadInstructorsData() {
            try {
                const instructorsSnapshot = await db.collection('users').where('role', '==', 'instructor').get();
                instructors = instructorsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateInstructorsTable();
            } catch (error) {
                console.error('Error loading instructors:', error);
            }
        }

        async function loadStudentsData() {
            try {
                const studentsSnapshot = await db.collection('users').where('role', '==', 'student').get();
                students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateStudentsTable();
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function populateInstructorsTable() {
            const tableBody = document.getElementById('instructorTableBody');

            if (instructors.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No instructors found</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            instructors.forEach(instructor => {
                const school = schools.find(s => s.id === instructor.schoolId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${instructor.firstName} ${instructor.lastName}</td>
                    <td>${instructor.email}</td>
                    <td>${instructor.programs ? instructor.programs.length : 0} programs</td>
                    <td>${instructor.classes ? instructor.classes.length : 0} classes</td>
                    <td>${school ? school.name : 'N/A'}</td>
                    <td><span class="status-badge ${instructor.isActive ? 'status-active' : 'status-inactive'}">${instructor.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td class="action-buttons">
                        <button class="action-btn btn-primary btn-sm" onclick="editInstructor('${instructor.id}')">Edit</button>
                        <button class="action-btn btn-danger btn-sm" onclick="deleteInstructor('${instructor.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function populateStudentsTable() {
            const tableBody = document.getElementById('studentTableBody');

            if (students.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No students found</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            students.forEach(student => {
                const school = schools.find(s => s.id === student.schoolId);
                const studentClass = classes.find(c => c.id === student.classId);
                const isSelected = selectedStudents.has(student.id);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="student-checkbox" data-student-id="${student.id}" ${isSelected ? 'checked' : ''} onchange="toggleStudentSelection(this)"></td>
                    <td>${student.email}</td>
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${studentClass ? studentClass.name : 'N/A'}</td>
                    <td>${school ? school.name : 'N/A'}</td>
                    <td><span class="status-badge ${student.isActive ? 'status-active' : 'status-inactive'}">${student.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td class="action-buttons">
                        <button class="action-btn btn-warning btn-sm" onclick="transferSingleStudent('${student.id}')">Transfer</button>
                        <button class="action-btn btn-primary btn-sm" onclick="editStudent('${student.id}')">Edit</button>
                        <button class="action-btn btn-danger btn-sm" onclick="deleteStudent('${student.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Form Population
        function populateInstructorForm() {
            const programsSelect = document.getElementById('instructorPrograms');
            programsSelect.innerHTML = '';

            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = program.name;
                programsSelect.appendChild(option);
            });
        }

        function populateStudentForm() {
            const classSelect = document.getElementById('studentClass');
            const currentValue = classSelect.value;
            classSelect.innerHTML = '<option value="">Select Class</option>';

            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                classSelect.appendChild(option);
            });

            if (currentValue) classSelect.value = currentValue;
        }

        function populateProgramForm() {
            // Already handled by populateSchoolDropdowns
        }

        function populateClassForm() {
            const programSelect = document.getElementById('classProgram');
            programSelect.innerHTML = '<option value="">Select Program</option>';

            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = program.name;
                programSelect.appendChild(option);
            });
        }

        function populateQuestionBankFilters() {
            // Populate filter dropdowns
            const filterProgram = document.getElementById('filterProgram');
            const filterClass = document.getElementById('filterClass');
            const filterSchool = document.getElementById('filterSchool');

            // Populate programs filter
            filterProgram.innerHTML = '<option value="">All Programs</option>';
            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = program.name;
                filterProgram.appendChild(option);
            });

            // Populate classes filter
            filterClass.innerHTML = '<option value="">All Classes</option>';
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                filterClass.appendChild(option);
            });

            // Populate schools filter
            filterSchool.innerHTML = '<option value="">All Schools</option>';
            schools.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.name;
                filterSchool.appendChild(option);
            });
        }

        function populateQuestionForm() {
            const programSelect = document.getElementById('questionProgram');
            const classSelect = document.getElementById('questionClass');
            const schoolSelect = document.getElementById('questionSchool');

            // Store current values
            const currentProgram = programSelect.value;
            const currentClass = classSelect.value;
            const currentSchool = schoolSelect.value;

            // Populate programs
            programSelect.innerHTML = '<option value="">Select Program</option>';
            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = program.name;
                programSelect.appendChild(option);
            });

            // Populate classes
            classSelect.innerHTML = '<option value="">Select Class</option>';
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                classSelect.appendChild(option);
            });

            // Populate schools
            schoolSelect.innerHTML = '<option value="">Select School</option>';
            schools.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.name;
                schoolSelect.appendChild(option);
            });

            // Restore previous selections if they exist
            if (currentProgram) programSelect.value = currentProgram;
            if (currentClass) classSelect.value = currentClass;
            if (currentSchool) schoolSelect.value = currentSchool;
        }


        function populateBulkUploadForm() {
            const uploadProgram = document.getElementById('uploadProgram');
            const uploadClass = document.getElementById('uploadClass');
            const uploadSchool = document.getElementById('uploadSchool');

            // Populate programs dropdown
            uploadProgram.innerHTML = '<option value="">Select Program</option>';
            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = program.name;
                uploadProgram.appendChild(option);
            });

            // Populate classes dropdown
            uploadClass.innerHTML = '<option value="">Select Class</option>';
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                uploadClass.appendChild(option);
            });

            // Populate schools dropdown
            uploadSchool.innerHTML = '<option value="">Select School</option>';
            schools.forEach(school => {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = school.name;
                uploadSchool.appendChild(option);
            });
        }

        // Save Functions
        async function saveInstructor() {
            const formData = {
                firstName: document.getElementById('instructorFirstName').value,
                lastName: document.getElementById('instructorLastName').value,
                email: document.getElementById('instructorEmail').value,
                password: document.getElementById('instructorPassword').value,
                schoolId: document.getElementById('instructorSchool').value,
                programs: Array.from(document.getElementById('instructorPrograms').selectedOptions).map(opt => opt.value),
                role: 'instructor',
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('users').add(formData);
                hideModal('addInstructorModal');
                document.getElementById('addInstructorForm').reset();
                loadInstructorsData();
                loadDashboardData();
                showNotification('Instructor created successfully!', 'success');
            } catch (error) {
                console.error('Error saving instructor:', error);
                showNotification('Error creating instructor. Please try again.', 'error');
            }
        }

        async function saveStudent() {
            const formData = {
                firstName: document.getElementById('studentFirstName').value,
                lastName: document.getElementById('studentLastName').value,
                email: document.getElementById('studentEmail').value,
                password: document.getElementById('studentPassword').value,
                schoolId: document.getElementById('studentSchool').value,
                classId: document.getElementById('studentClass').value,
                role: 'student',
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('users').add(formData);
                hideModal('addStudentModal');
                document.getElementById('addStudentForm').reset();
                loadStudentsData();
                loadDashboardData();
                showNotification('Student created successfully!', 'success');
            } catch (error) {
                console.error('Error saving student:', error);
                showNotification('Error creating student. Please try again.', 'error');
            }
        }

        async function saveProgram() {
            const formData = {
                name: document.getElementById('programName').value,
                code: document.getElementById('programCode').value,
                description: document.getElementById('programDescription').value,
                schoolId: document.getElementById('programSchool').value,
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('programs').add(formData);
                hideModal('addProgramModal');
                document.getElementById('addProgramForm').reset();
                loadPrograms();
                loadDashboardData();
                showNotification('Program created successfully!', 'success');
            } catch (error) {
                console.error('Error saving program:', error);
                showNotification('Error creating program. Please try again.', 'error');
            }
        }

        async function saveClass() {
            const formData = {
                name: document.getElementById('className').value,
                code: document.getElementById('classCode').value,
                level: document.getElementById('classLevel').value,
                programId: document.getElementById('classProgram').value,
                schoolId: document.getElementById('classSchool').value,
                description: document.getElementById('classDescription').value,
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('classes').add(formData);
                hideModal('addClassModal');
                document.getElementById('addClassForm').reset();
                loadClasses();
                loadDashboardData();
                showNotification('Class created successfully!', 'success');
            } catch (error) {
                console.error('Error saving class:', error);
                showNotification('Error creating class. Please try again.', 'error');
            }
        }

        async function saveQuestion() {
            const formData = {
                text: document.getElementById('questionText').value,
                programId: document.getElementById('questionProgram').value,
                classId: document.getElementById('questionClass').value,
                schoolId: document.getElementById('questionSchool').value,
                marks: parseInt(document.getElementById('questionMarks').value),
                options: {
                    A: document.getElementById('optionA').value,
                    B: document.getElementById('optionB').value,
                    C: document.getElementById('optionC').value,
                    D: document.getElementById('optionD').value
                },
                correctAnswer: document.getElementById('correctOption').value,
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('questions').add(formData);
                hideModal('addQuestionModal');
                document.getElementById('addQuestionForm').reset();
                loadQuestionsData();
                loadDashboardData();
                showNotification('Question created successfully!', 'success');
            } catch (error) {
                console.error('Error saving question:', error);
                showNotification('Error creating question. Please try again.', 'error');
            }
        }

        async function saveSchool() {
            const formData = {
                name: document.getElementById('schoolName').value,
                code: document.getElementById('schoolCode').value,
                address: document.getElementById('schoolAddress').value,
                phone: document.getElementById('schoolPhone').value,
                email: document.getElementById('schoolEmail').value,
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('schools').add(formData);
                hideModal('addSchoolModal');
                document.getElementById('addSchoolForm').reset();
                loadSchools();
                loadDashboardData();
                showNotification('School created successfully!', 'success');
            } catch (error) {
                console.error('Error saving school:', error);
                showNotification('Error creating school. Please try again.', 'error');
            }
        }

        async function saveExam() {
            const formData = {
                title: document.getElementById('examTitle').value,
                programId: document.getElementById('examProgram').value,
                classId: document.getElementById('examClass').value,
                schoolId: document.getElementById('examSchool').value,
                duration: parseInt(document.getElementById('examDuration').value),
                totalQuestions: parseInt(document.getElementById('examQuestions').value),
                instructions: document.getElementById('examInstructions').value,
                status: 'draft',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('exams').add(formData);
                hideModal('createExamModal');
                document.getElementById('createExamForm').reset();
                loadExamsData();
                loadDashboardData();
                showNotification('Assessment created successfully!', 'success');
            } catch (error) {
                console.error('Error saving assessment:', error);
                showNotification('Error creating assessment. Please try again.', 'error');
            }
        }

        // Student Transfer Functions
        function toggleSelectAllStudents(checkbox) {
            const studentCheckboxes = document.querySelectorAll('.student-checkbox');
            studentCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const studentId = cb.getAttribute('data-student-id');
                if (checkbox.checked) {
                    selectedStudents.add(studentId);
                } else {
                    selectedStudents.delete(studentId);
                }
            });
            updateSelectedStudentsDisplay();
        }

        function toggleStudentSelection(checkbox) {
            const studentId = checkbox.getAttribute('data-student-id');
            if (checkbox.checked) {
                selectedStudents.add(studentId);
            } else {
                selectedStudents.delete(studentId);
            }
            updateSelectedStudentsDisplay();
        }

        function updateSelectedStudentsDisplay() {
            const countElement = document.getElementById('selectedStudentsCount');
            const listElement = document.getElementById('selectedStudentsList');

            countElement.textContent = selectedStudents.size;

            if (selectedStudents.size === 0) {
                listElement.innerHTML = '<p style="text-align: center; color: #666; margin: 0;">No students selected</p>';
                return;
            }

            let listHTML = '';
            selectedStudents.forEach(studentId => {
                const student = students.find(s => s.id === studentId);
                if (student) {
                    const studentClass = classes.find(c => c.id === student.classId);
                    const school = schools.find(s => s.id === student.schoolId);

                    listHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #f0f0f0;">
                            <div style="flex: 1;">
                                <strong>${student.firstName} ${student.lastName}</strong> (${student.email})
                            </div>
                            <div style="color: #666; font-size: 0.9em;">
                                ${studentClass ? studentClass.name : 'N/A'} - ${school ? school.name : 'N/A'}
                            </div>
                        </div>
                    `;
                }
            });

            listElement.innerHTML = listHTML;
        }

        function showTransferModal() {
            if (selectedStudents.size === 0) {
                showNotification('Please select at least one student to transfer.', 'warning');
                return;
            }

            showModal('transferStudentsModal');
        }

        async function transferStudents() {
            const targetSchoolId = document.getElementById('transferToSchool').value;
            const targetClassId = document.getElementById('transferToClass').value;
            const effectiveDate = document.getElementById('transferEffectiveDate').value;
            const notes = document.getElementById('transferNotes').value;

            if (!targetSchoolId || !targetClassId) {
                showNotification('Please select both target school and class.', 'error');
                return;
            }

            const transferBtn = document.getElementById('confirmTransferBtn');
            const originalText = transferBtn.innerHTML;
            transferBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Transferring...';
            transferBtn.disabled = true;

            try {
                let successCount = 0;
                let errorCount = 0;

                for (const studentId of selectedStudents) {
                    try {
                        // Update student school and class
                        await db.collection('users').doc(studentId).update({
                            schoolId: targetSchoolId,
                            classId: targetClassId,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Create transfer record
                        const student = students.find(s => s.id === studentId);
                        const fromSchool = schools.find(s => s.id === student.schoolId);
                        const fromClass = classes.find(c => c.id === student.classId);
                        const toSchool = schools.find(s => s.id === targetSchoolId);
                        const toClass = classes.find(c => c.id === targetClassId);

                        const transferRecord = {
                            studentId: studentId,
                            fromSchool: fromSchool ? fromSchool.name : 'Unknown',
                            fromClass: fromClass ? fromClass.name : 'Unknown',
                            toSchool: toSchool ? toSchool.name : 'Unknown',
                            toClass: toClass ? toClass.name : 'Unknown',
                            effectiveDate: new Date(effectiveDate),
                            notes: notes,
                            transferredBy: currentAdmin.userId,
                            transferredAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        await db.collection('student_transfers').add(transferRecord);
                        successCount++;

                    } catch (error) {
                        console.error(`Error transferring student ${studentId}:`, error);
                        errorCount++;
                    }
                }

                hideModal('transferStudentsModal');

                if (errorCount === 0) {
                    showNotification(`Successfully transferred ${successCount} student(s)!`, 'success');
                } else {
                    showNotification(`Transferred ${successCount} student(s), ${errorCount} failed.`, 'warning');
                }

                // Clear selection and reload data
                selectedStudents.clear();
                document.getElementById('selectAllStudents').checked = false;
                loadStudentsData();

            } catch (error) {
                console.error('Error in transfer process:', error);
                showNotification('Error transferring students. Please try again.', 'error');
            } finally {
                transferBtn.innerHTML = originalText;
                transferBtn.disabled = false;
            }
        }

        function transferSingleStudent(studentId) {
            selectedStudents.clear();
            selectedStudents.add(studentId);
            showTransferModal();
        }

        // Bulk Upload Functions
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('fileUploadArea').classList.add('active');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('fileUploadArea').classList.remove('active');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleExcelFile(files[0]);
            }
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                handleExcelFile(file);
            }
        }

        function handleExcelFile(file) {
            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel'
            ];

            if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/)) {
                showNotification('Please upload a valid Excel file (.xlsx or .xls)', 'error');
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    if (workbook.SheetNames.length === 0) {
                        showNotification('The Excel file is empty or corrupted', 'error');
                        return;
                    }

                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        showNotification('No data found in the Excel sheet', 'error');
                        return;
                    }

                    processExcelData(jsonData);
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    showNotification('Error reading Excel file. Please check the format.', 'error');
                }
            };

            reader.onerror = function () {
                showNotification('Error reading file. Please try again.', 'error');
            };

            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            uploadedQuestions = [];

            data.forEach((row, index) => {
                const questionText = row.Question || row.question || row['Question Text'] || row.questionText || '';
                const optionA = row.Option_A || row.optionA || row['Choice A'] || row['Option A'] || '';
                const optionB = row.Option_B || row.optionB || row['Choice B'] || row['Option B'] || '';
                const optionC = row.Option_C || row.optionC || row['Choice C'] || row['Option C'] || '';
                const optionD = row.Option_D || row.optionD || row['Choice D'] || row['Option D'] || '';
                const correctAnswer = row.Correct_Answer || row.correctAnswer || row['Correct Option'] || row['Correct Answer'] || '';

                if (questionText && optionA && optionB && correctAnswer) {
                    const cleanCorrectAnswer = correctAnswer.toString().toUpperCase().trim();
                    const validAnswers = ['A', 'B', 'C', 'D'];

                    if (validAnswers.includes(cleanCorrectAnswer)) {
                        uploadedQuestions.push({
                            questionText: questionText.toString().trim(), // Use questionText field
                            options: {
                                A: optionA.toString().trim(),
                                B: optionB.toString().trim(),
                                C: optionC.toString().trim(),
                                D: optionD.toString().trim()
                            },
                            correctAnswer: cleanCorrectAnswer,
                            marks: parseInt(row.Marks || row.marks || 1)
                        });
                    }
                }
            });

            if (uploadedQuestions.length === 0) {
                showNotification('No valid questions found in the file. Please check the format.', 'error');
                return;
            }

            showUploadPreview();
        }

        function showUploadPreview() {
            const previewTableBody = document.getElementById('previewTableBody');
            const filePreview = document.getElementById('filePreview');
            const processBtn = document.getElementById('processUploadBtn');

            previewTableBody.innerHTML = '';
            uploadedQuestions.slice(0, 5).forEach((question, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${question.questionText.substring(0, 50)}${question.questionText.length > 50 ? '...' : ''}</td>
                    <td>${question.options.A.substring(0, 20)}${question.options.A.length > 20 ? '...' : ''}</td>
                    <td>${question.options.B.substring(0, 20)}${question.options.B.length > 20 ? '...' : ''}</td>
                    <td>${question.options.C.substring(0, 20)}${question.options.C.length > 20 ? '...' : ''}</td>
                    <td>${question.options.D.substring(0, 20)}${question.options.D.length > 20 ? '...' : ''}</td>
                    <td>${question.correctAnswer}</td>
                `;
                previewTableBody.appendChild(row);
            });

            if (uploadedQuestions.length > 5) {
                const moreRow = document.createElement('tr');
                moreRow.innerHTML = `<td colspan="6" style="text-align: center; color: #666;">... and ${uploadedQuestions.length - 5} more questions</td>`;
                previewTableBody.appendChild(moreRow);
            }

            filePreview.style.display = 'block';
            processBtn.disabled = false;
            showNotification(`Successfully loaded ${uploadedQuestions.length} questions from the file`, 'success');
        }

        async function processBulkUpload() {
            const programId = document.getElementById('uploadProgram').value;
            const classId = document.getElementById('uploadClass').value;
            const schoolId = document.getElementById('uploadSchool').value;

            if (!programId || !classId || !schoolId) {
                showNotification('Please select program, class, and school.', 'error');
                return;
            }

            const processBtn = document.getElementById('processUploadBtn');
            const originalText = processBtn.innerHTML;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            processBtn.disabled = true;

            try {
                let successCount = 0;
                let errorCount = 0;

                for (const [index, questionData] of uploadedQuestions.entries()) {
                    try {
                        const fullQuestionData = {
                            ...questionData,
                            programId: programId,
                            classId: classId,
                            schoolId: schoolId,
                            isActive: true,
                            createdBy: currentAdmin.userId,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        await db.collection('questions').add(fullQuestionData);
                        successCount++;
                    } catch (error) {
                        console.error(`Error saving question ${index + 1}:`, error);
                        errorCount++;
                    }
                }

                hideModal('bulkUploadModal');

                if (errorCount === 0) {
                    showNotification(`Successfully uploaded ${successCount} questions!`, 'success');
                } else {
                    showNotification(`Uploaded ${successCount} questions. ${errorCount} failed.`, 'warning');
                }

                loadQuestionsData();

            } catch (error) {
                console.error('Error in bulk upload:', error);
                showNotification('Error processing bulk upload. Please try again.', 'error');
            } finally {
                processBtn.innerHTML = originalText;
                processBtn.disabled = false;
            }
        }

        // Other Section Data Loading
        // Update the loadProgramsData function to load both programs and classes data
        async function loadProgramsData() {
            try {
                // Load programs data
                const programsSnapshot = await db.collection('programs').get();
                const programsData = programsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateProgramsTable(programsData);

                // Load classes data
                const classesSnapshot = await db.collection('classes').get();
                const classesData = classesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateClassesTable(classesData);

            } catch (error) {
                console.error('Error loading programs data:', error);
            }
        }

        // Add this function to populate the classes table
        function populateClassesTable(classesData) {
            const tableBody = document.getElementById('classesTableBody');

            if (classesData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No classes found</td></tr>';
                return;
            }

            tableBody.innerHTML = '';

            classesData.forEach(cls => {
                const program = programs.find(p => p.id === cls.programId);
                const school = schools.find(s => s.id === cls.schoolId);
                const instructor = instructors.find(i => i.classes && i.classes.includes(cls.id));

                // Count students in this class
                const studentsInClass = students.filter(s => s.classId === cls.id).length;

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${cls.name}</td>
            <td>${cls.code}</td>
            <td>
                <span class="status-badge" style="
                    background: ${getLevelColor(cls.level)};
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 0.8em;
                ">
                    ${cls.level ? cls.level.charAt(0).toUpperCase() + cls.level.slice(1) : 'N/A'}
                </span>
            </td>
            <td>${studentsInClass}</td>
            <td>${instructor ? `${instructor.firstName} ${instructor.lastName}` : 'Not Assigned'}</td>
            <td>${school ? school.name : 'N/A'}</td>
            <td>${cls.description || '-'}</td>
            <td class="action-buttons">
                <button class="action-btn btn-primary btn-sm" onclick="editClass('${cls.id}')">Edit</button>
                <button class="action-btn btn-danger btn-sm" onclick="deleteClass('${cls.id}')">Delete</button>
            </td>
        `;
                tableBody.appendChild(row);
            });
        }

        // Helper function for level colors
        function getLevelColor(level) {
            const colors = {
                'beginner': '#28a745',
                'intermediate': '#ffc107',
                'advanced': '#dc3545'
            };
            return colors[level] || '#6c757d';
        }

        // Add class edit functionality
        async function editClass(classId) {
            try {
                const cls = classes.find(c => c.id === classId);
                if (!cls) {
                    showNotification('Class not found', 'error');
                    return;
                }

                await loadSchoolsAndPrograms();

                // Populate the form with existing data
                document.getElementById('className').value = cls.name || '';
                document.getElementById('classCode').value = cls.code || '';
                document.getElementById('classLevel').value = cls.level || '';
                document.getElementById('classProgram').value = cls.programId || '';
                document.getElementById('classSchool').value = cls.schoolId || '';
                document.getElementById('classDescription').value = cls.description || '';

                // Store the class ID for updating
                const saveBtn = document.getElementById('saveClassBtn');
                saveBtn.setAttribute('data-edit-id', classId);
                saveBtn.textContent = 'Update Class';

                // Change the modal title
                document.querySelector('#addClassModal .modal-title').textContent = 'Edit Class';

                showModal('addClassModal');

            } catch (error) {
                console.error('Error loading class data:', error);
                showNotification('Error loading class data', 'error');
            }
        }

        // Add class delete functionality
        async function deleteClass(classId) {
            if (confirm('Are you sure you want to delete this class? This will affect all students in this class.')) {
                try {
                    await db.collection('classes').doc(classId).delete();
                    showNotification('Class deleted successfully!', 'success');
                    loadProgramsData(); // Reload the data
                    loadDashboardData();
                } catch (error) {
                    console.error('Error deleting class:', error);
                    showNotification('Error deleting class. Please try again.', 'error');
                }
            }
        }

        // Update the saveClass function to handle both create and update
        async function saveClass() {
            const saveBtn = document.getElementById('saveClassBtn');
            const isEdit = saveBtn.hasAttribute('data-edit-id');
            const classId = isEdit ? saveBtn.getAttribute('data-edit-id') : null;

            const formData = {
                name: document.getElementById('className').value,
                code: document.getElementById('classCode').value,
                level: document.getElementById('classLevel').value,
                programId: document.getElementById('classProgram').value,
                schoolId: document.getElementById('classSchool').value,
                description: document.getElementById('classDescription').value,
                isActive: true,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (isEdit) {
                delete formData.createdAt;
            } else {
                formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                if (isEdit) {
                    await db.collection('classes').doc(classId).update(formData);
                    showNotification('Class updated successfully!', 'success');
                } else {
                    await db.collection('classes').add(formData);
                    showNotification('Class created successfully!', 'success');
                }

                hideModal('addClassModal');
                resetClassForm();
                loadProgramsData();
                loadDashboardData();

            } catch (error) {
                console.error('Error saving class:', error);
                showNotification('Error saving class. Please try again.', 'error');
            }
        }

        // Add reset function for class form
        function resetClassForm() {
            document.getElementById('addClassForm').reset();
            const saveBtn = document.getElementById('saveClassBtn');
            saveBtn.removeAttribute('data-edit-id');
            saveBtn.textContent = 'Save Class';
            document.querySelector('#addClassModal .modal-title').textContent = 'Add New Class';
        }

        // Update the cancel button for class form
        document.getElementById('cancelClassBtn').addEventListener('click', function () {
            hideModal('addClassModal');
            resetClassForm();
        });

        // Add event listeners for filter changes in question bank
        document.addEventListener('DOMContentLoaded', function () {
            // Add filter functionality for question bank
            const filterProgram = document.getElementById('filterProgram');
            const filterClass = document.getElementById('filterClass');
            const filterSchool = document.getElementById('filterSchool');

            if (filterProgram) {
                filterProgram.addEventListener('change', filterQuestions);
            }
            if (filterClass) {
                filterClass.addEventListener('change', filterQuestions);
            }
            if (filterSchool) {
                filterSchool.addEventListener('change', filterQuestions);
            }
        });

        // Filter questions based on selected filters
        async function filterQuestions() {
            const programId = document.getElementById('filterProgram').value;
            const classId = document.getElementById('filterClass').value;
            const schoolId = document.getElementById('filterSchool').value;

            try {
                let query = db.collection('questions');

                // Apply filters if selected
                if (programId) {
                    query = query.where('programId', '==', programId);
                }
                if (classId) {
                    query = query.where('classId', '==', classId);
                }
                if (schoolId) {
                    query = query.where('schoolId', '==', schoolId);
                }

                const questionsSnapshot = await query.get();
                const filteredQuestions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Update the global questions array with filtered results
                questions = filteredQuestions;

                populateQuestionsTable(filteredQuestions);

            } catch (error) {
                console.error('Error filtering questions:', error);
                showNotification('Error filtering questions', 'error');
            }
        }

        // Also update the programs table to show actual instructor count
        function populateProgramsTable(programsData) {
            const tableBody = document.getElementById('programsTableBody');

            if (programsData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No programs found</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            programsData.forEach(program => {
                const school = schools.find(s => s.id === program.schoolId);

                // Count instructors assigned to this program
                const programInstructors = instructors.filter(i =>
                    i.programs && i.programs.includes(program.id)
                ).length;

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${program.name}</td>
            <td>${program.code}</td>
            <td>${program.description || '-'}</td>
            <td>${programInstructors} instructor(s)</td>
            <td>${school ? school.name : 'N/A'}</td>
            <td><span class="status-badge ${program.isActive ? 'status-active' : 'status-inactive'}">${program.isActive ? 'Active' : 'Inactive'}</span></td>
            <td class="action-buttons">
                <button class="action-btn btn-primary btn-sm" onclick="editProgram('${program.id}')">Edit</button>
                <button class="action-btn btn-danger btn-sm" onclick="deleteProgram('${program.id}')">Delete</button>
            </td>
        `;
                tableBody.appendChild(row);
            });
        }

        // Add program edit functionality (similar to class)
        async function editProgram(programId) {
            try {
                const program = programs.find(p => p.id === programId);
                if (!program) {
                    showNotification('Program not found', 'error');
                    return;
                }

                await loadSchools();

                // Populate the form with existing data
                document.getElementById('programName').value = program.name || '';
                document.getElementById('programCode').value = program.code || '';
                document.getElementById('programDescription').value = program.description || '';
                document.getElementById('programSchool').value = program.schoolId || '';

                // Store the program ID for updating
                const saveBtn = document.getElementById('saveProgramBtn');
                saveBtn.setAttribute('data-edit-id', programId);
                saveBtn.textContent = 'Update Program';

                // Change the modal title
                document.querySelector('#addProgramModal .modal-title').textContent = 'Edit Program';

                showModal('addProgramModal');

            } catch (error) {
                console.error('Error loading program data:', error);
                showNotification('Error loading program data', 'error');
            }
        }

        // Add program delete functionality
        async function deleteProgram(programId) {
            if (confirm('Are you sure you want to delete this program? This will affect all classes and questions in this program.')) {
                try {
                    await db.collection('programs').doc(programId).delete();
                    showNotification('Program deleted successfully!', 'success');
                    loadProgramsData(); // Reload the data
                    loadDashboardData();
                } catch (error) {
                    console.error('Error deleting program:', error);
                    showNotification('Error deleting program. Please try again.', 'error');
                }
            }
        }

        // Update the saveProgram function to handle both create and update
        async function saveProgram() {
            const saveBtn = document.getElementById('saveProgramBtn');
            const isEdit = saveBtn.hasAttribute('data-edit-id');
            const programId = isEdit ? saveBtn.getAttribute('data-edit-id') : null;

            const formData = {
                name: document.getElementById('programName').value,
                code: document.getElementById('programCode').value,
                description: document.getElementById('programDescription').value,
                schoolId: document.getElementById('programSchool').value,
                isActive: true,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (isEdit) {
                delete formData.createdAt;
            } else {
                formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                if (isEdit) {
                    await db.collection('programs').doc(programId).update(formData);
                    showNotification('Program updated successfully!', 'success');
                } else {
                    await db.collection('programs').add(formData);
                    showNotification('Program created successfully!', 'success');
                }

                hideModal('addProgramModal');
                resetProgramForm();
                loadProgramsData();
                loadDashboardData();

            } catch (error) {
                console.error('Error saving program:', error);
                showNotification('Error saving program. Please try again.', 'error');
            }
        }

        // Add reset function for program form
        function resetProgramForm() {
            document.getElementById('addProgramForm').reset();
            const saveBtn = document.getElementById('saveProgramBtn');
            saveBtn.removeAttribute('data-edit-id');
            saveBtn.textContent = 'Save Program';
            document.querySelector('#addProgramModal .modal-title').textContent = 'Add New Program';
        }

        // Update the cancel button for program form
        document.getElementById('cancelProgramBtn').addEventListener('click', function () {
            hideModal('addProgramModal');
            resetProgramForm();
        });

        async function loadQuestionsData() {
            try {
                const questionsSnapshot = await db.collection('questions').get();
                questions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Populate the filters first
                populateQuestionBankFilters();

                // Update the header with bulk delete button
                updateQuestionBankHeader();

                // Then populate the table
                populateQuestionsTable(questions);

            } catch (error) {
                console.error('Error loading questions data:', error);
            }
        }

        // Update the exams table header to include new columns
        function updateExamsTableHeader() {
            const examsTable = document.querySelector('#examsTableBody').closest('table');
            const thead = examsTable.querySelector('thead');

            // Check if we need to update the header
            const currentHeaders = thead.querySelectorAll('th');
            if (currentHeaders.length < 10) { // We need 10 columns now
                const headerRow = thead.querySelector('tr');
                if (headerRow) {
                    // Insert new headers after the existing ones
                    const durationHeader = headerRow.querySelector('th:nth-child(5)');
                    if (durationHeader) {
                        // Insert Available From header
                        const availableFromHeader = document.createElement('th');
                        availableFromHeader.textContent = 'Available From';
                        headerRow.insertBefore(availableFromHeader, durationHeader.nextSibling);

                        // Insert Available To header
                        const availableToHeader = document.createElement('th');
                        availableToHeader.textContent = 'Available To';
                        headerRow.insertBefore(availableToHeader, availableFromHeader.nextSibling);
                    }
                }
            }
        }

        async function loadExamsData() {
            try {
                const examsSnapshot = await db.collection('exams').get();
                const examsData = examsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Update table header for new columns
                updateExamsTableHeader();

                populateExamsTable(examsData);
            } catch (error) {
                console.error('Error loading exams data:', error);
            }
        }

        async function loadResultsData() {
            // Load exams for dropdown
            try {
                const examsSnapshot = await db.collection('exams').get();
                const examSelect = document.getElementById('resultsExam');
                examSelect.innerHTML = '<option value="">Select Assessment</option>';

                examsSnapshot.forEach(doc => {
                    const exam = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = exam.title;
                    examSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading exams for results:', error);
            }
        }

        async function loadSettingsData() {
            // Load schools for settings
            try {
                const schoolsSnapshot = await db.collection('schools').get();
                const schoolsData = schoolsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateSchoolsTable(schoolsData);
            } catch (error) {
                console.error('Error loading schools data:', error);
            }
        }

        // Table Population Functions
        function populateProgramsTable(programsData) {
            const tableBody = document.getElementById('programsTableBody');

            if (programsData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No programs found</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            programsData.forEach(program => {
                const school = schools.find(s => s.id === program.schoolId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${program.name}</td>
                    <td>${program.code}</td>
                    <td>${program.description || '-'}</td>
                    <td>0 instructors</td> <!-- Would need to calculate this -->
                    <td>${school ? school.name : 'N/A'}</td>
                    <td><span class="status-badge ${program.isActive ? 'status-active' : 'status-inactive'}">${program.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td class="action-buttons">
                        <button class="action-btn btn-primary btn-sm">Edit</button>
                        <button class="action-btn btn-danger btn-sm">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function populateQuestionsTable(questionsData) {
            const tableBody = document.getElementById('questionsTableBody');

            if (questionsData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No questions found</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            questionsData.forEach(question => {
                const program = programs.find(p => p.id === question.programId);
                const questionClass = classes.find(c => c.id === question.classId);
                const school = schools.find(s => s.id === question.schoolId);

                // Use questionText field instead of text
                const questionText = question.questionText || question.text || 'No question text';

                const row = document.createElement('tr');
                row.innerHTML = `
            <td width="50px">
                <input type="checkbox" class="question-checkbox" data-question-id="${question.id}" onchange="toggleQuestionSelection(this)">
            </td>
            <td>
                <div style="max-width: 300px;">
                    <strong>${questionText.substring(0, 100)}${questionText.length > 100 ? '...' : ''}</strong>
                    ${question.options ? `
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                        Options: 
                        ${Object.entries(question.options).map(([key, value]) =>
                    `${key}: ${value}${key === question.correctAnswer ? ' ✓' : ''}`
                ).join(', ')}
                    </div>
                    ` : ''}
                </div>
            </td>
            <td>${program ? program.name : 'N/A'}</td>
            <td>${questionClass ? questionClass.name : 'N/A'}</td>
            <td>${school ? school.name : 'N/A'}</td>
            <td>${question.marks || 1}</td>
            <td class="action-buttons">
                <button class="action-btn btn-primary btn-sm" onclick="editQuestion('${question.id}')">Edit</button>
                <button class="action-btn btn-danger btn-sm" onclick="deleteQuestion('${question.id}')">Delete</button>
                <button class="action-btn btn-info btn-sm" onclick="viewQuestion('${question.id}')">View</button>
            </td>
        `;
                tableBody.appendChild(row);
            });
        }

        // Add global variable to track selected questions
        let selectedQuestions = new Set();

        // Function to toggle question selection
        function toggleQuestionSelection(checkbox) {
            const questionId = checkbox.getAttribute('data-question-id');
            if (checkbox.checked) {
                selectedQuestions.add(questionId);
            } else {
                selectedQuestions.delete(questionId);
            }
            updateBulkDeleteButton();
        }

        // Also update the reset function for when forms are closed/cancelled
        function resetQuestionSelections() {
            selectedQuestions.clear();
            if (document.getElementById('selectAllQuestions')) {
                document.getElementById('selectAllQuestions').checked = false;
            }
            updateBulkDeleteButton();
        }

        // Call this when the question bank section is shown
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            // Load section-specific data
            switch (sectionId) {
                case 'users':
                    loadUsersData();
                    break;
                case 'programs':
                    loadProgramsData();
                    break;
                case 'questions':
                    loadQuestionsData();
                    // Reset selections when switching to questions section
                    resetQuestionSelections();
                    break;
                case 'exams':
                    loadExamsData();
                    break;
                case 'results':
                    loadResultsData();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
            }
        }

        // Function to select/deselect all questions
        function toggleSelectAllQuestions(checkbox) {
            const questionCheckboxes = document.querySelectorAll('.question-checkbox');
            questionCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const questionId = cb.getAttribute('data-question-id');
                if (checkbox.checked) {
                    selectedQuestions.add(questionId);
                } else {
                    selectedQuestions.delete(questionId);
                }
            });
            updateBulkDeleteButton();
        }

        // Function to update bulk delete button state
        function updateBulkDeleteButton() {
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            if (bulkDeleteBtn) {
                bulkDeleteBtn.disabled = selectedQuestions.size === 0;
                bulkDeleteBtn.textContent = `Bulk Delete (${selectedQuestions.size})`;
            }
        }

        // Function to perform bulk delete
        async function bulkDeleteQuestions() {
            if (selectedQuestions.size === 0) {
                showNotification('Please select at least one question to delete.', 'warning');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selectedQuestions.size} question(s)? This action cannot be undone.`)) {
                return;
            }

            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const originalText = bulkDeleteBtn.innerHTML;
            bulkDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            bulkDeleteBtn.disabled = true;

            try {
                let successCount = 0;
                let errorCount = 0;

                // Delete questions one by one
                for (const questionId of selectedQuestions) {
                    try {
                        await db.collection('questions').doc(questionId).delete();
                        successCount++;
                    } catch (error) {
                        console.error(`Error deleting question ${questionId}:`, error);
                        errorCount++;
                    }
                }

                // Clear selection
                selectedQuestions.clear();
                document.getElementById('selectAllQuestions').checked = false;
                updateBulkDeleteButton();

                if (errorCount === 0) {
                    showNotification(`Successfully deleted ${successCount} question(s)!`, 'success');
                } else {
                    showNotification(`Deleted ${successCount} question(s), ${errorCount} failed.`, 'warning');
                }

                // Reload data
                loadQuestionsData();
                loadDashboardData();

            } catch (error) {
                console.error('Error in bulk delete process:', error);
                showNotification('Error during bulk delete. Please try again.', 'error');
            } finally {
                bulkDeleteBtn.innerHTML = originalText;
                bulkDeleteBtn.disabled = false;
            }
        }

        // Update the section header to include bulk delete button
        function updateQuestionBankHeader() {
            const sectionHeader = document.querySelector('#questions .section-header');

            // Check if bulk delete button already exists
            if (!document.getElementById('bulkDeleteBtn')) {
                const currentButtons = sectionHeader.querySelector('div');
                if (currentButtons) {
                    const bulkDeleteBtn = document.createElement('button');
                    bulkDeleteBtn.id = 'bulkDeleteBtn';
                    bulkDeleteBtn.className = 'btn btn-danger';
                    bulkDeleteBtn.innerHTML = '<i class="fas fa-trash"></i> Bulk Delete (0)';
                    bulkDeleteBtn.style.marginLeft = '10px';
                    bulkDeleteBtn.disabled = true;
                    bulkDeleteBtn.onclick = bulkDeleteQuestions;

                    currentButtons.appendChild(bulkDeleteBtn);
                }
            }
        }

        // Add question edit functionality
        async function editQuestion(questionId) {
            try {
                // Make sure questions array is populated
                if (!questions || questions.length === 0) {
                    await loadQuestionsData();
                }

                const question = questions.find(q => q.id === questionId);
                if (!question) {
                    showNotification('Question not found', 'error');
                    return;
                }

                await loadSchoolsProgramsClasses();

                // Populate the form with existing data - use questionText field
                document.getElementById('questionText').value = question.questionText || question.text || '';
                document.getElementById('questionProgram').value = question.programId || '';
                document.getElementById('questionClass').value = question.classId || '';
                document.getElementById('questionSchool').value = question.schoolId || '';
                document.getElementById('questionMarks').value = question.marks || 1;

                // Populate options
                if (question.options) {
                    document.getElementById('optionA').value = question.options.A || '';
                    document.getElementById('optionB').value = question.options.B || '';
                    document.getElementById('optionC').value = question.options.C || '';
                    document.getElementById('optionD').value = question.options.D || '';
                }

                document.getElementById('correctOption').value = question.correctAnswer || 'A';

                // Store the question ID for updating
                const saveBtn = document.getElementById('saveQuestionBtn');
                saveBtn.setAttribute('data-edit-id', questionId);
                saveBtn.textContent = 'Update Question';

                // Change the modal title
                document.querySelector('#addQuestionModal .modal-title').textContent = 'Edit Question';

                showModal('addQuestionModal');

            } catch (error) {
                console.error('Error loading question data:', error);
                showNotification('Error loading question data', 'error');
            }
        }

        // Add question delete functionality
        async function deleteQuestion(questionId) {
            try {
                // Make sure questions array is populated
                if (!questions || questions.length === 0) {
                    await loadQuestionsData();
                }

                if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
                    await db.collection('questions').doc(questionId).delete();
                    showNotification('Question deleted successfully!', 'success');
                    loadQuestionsData(); // Reload the questions array
                    loadDashboardData();
                }
            } catch (error) {
                console.error('Error deleting question:', error);
                showNotification('Error deleting question. Please try again.', 'error');
            }
        }

        // Add question view functionality
        async function viewQuestion(questionId) {
            try {
                // Make sure questions array is populated
                if (!questions || questions.length === 0) {
                    await loadQuestionsData();
                }

                const question = questions.find(q => q.id === questionId);
                if (!question) {
                    showNotification('Question not found', 'error');
                    return;
                }

                const program = programs.find(p => p.id === question.programId);
                const questionClass = classes.find(c => c.id === question.classId);
                const school = schools.find(s => s.id === question.schoolId);

                // Use questionText field
                const questionText = question.questionText || question.text || 'No question text';

                const questionDetails = `
Question Details:
----------------
Question: ${questionText}
Program: ${program ? program.name : 'N/A'}
Class: ${questionClass ? questionClass.name : 'N/A'}
School: ${school ? school.name : 'N/A'}
Marks: ${question.marks || 1}

Options:
A: ${question.options?.A || ''} ${question.correctAnswer === 'A' ? '✓' : ''}
B: ${question.options?.B || ''} ${question.correctAnswer === 'B' ? '✓' : ''}
C: ${question.options?.C || ''} ${question.correctAnswer === 'C' ? '✓' : ''}
D: ${question.options?.D || ''} ${question.correctAnswer === 'D' ? '✓' : ''}

Correct Answer: ${question.correctAnswer}
        `;

                alert(questionDetails);
            } catch (error) {
                console.error('Error viewing question:', error);
                showNotification('Error loading question details', 'error');
            }
        }

        // Update the saveQuestion function to handle both create and update
        async function saveQuestion() {
            const saveBtn = document.getElementById('saveQuestionBtn');
            const isEdit = saveBtn.hasAttribute('data-edit-id');
            const questionId = isEdit ? saveBtn.getAttribute('data-edit-id') : null;

            const formData = {
                questionText: document.getElementById('questionText').value, // Changed from 'text' to 'questionText'
                programId: document.getElementById('questionProgram').value,
                classId: document.getElementById('questionClass').value,
                schoolId: document.getElementById('questionSchool').value,
                marks: parseInt(document.getElementById('questionMarks').value),
                options: {
                    A: document.getElementById('optionA').value,
                    B: document.getElementById('optionB').value,
                    C: document.getElementById('optionC').value,
                    D: document.getElementById('optionD').value
                },
                correctAnswer: document.getElementById('correctOption').value,
                isActive: true,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (isEdit) {
                delete formData.createdAt;
            } else {
                formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                if (isEdit) {
                    await db.collection('questions').doc(questionId).update(formData);
                    showNotification('Question updated successfully!', 'success');
                } else {
                    await db.collection('questions').add(formData);
                    showNotification('Question created successfully!', 'success');
                }

                hideModal('addQuestionModal');
                resetQuestionForm();
                loadQuestionsData(); // This will reload the questions array
                loadDashboardData();

            } catch (error) {
                console.error('Error saving question:', error);
                showNotification('Error saving question. Please try again.', 'error');
            }
        }

        // Add reset function for question form
        function resetQuestionForm() {
            document.getElementById('addQuestionForm').reset();
            const saveBtn = document.getElementById('saveQuestionBtn');
            saveBtn.removeAttribute('data-edit-id');
            saveBtn.textContent = 'Save Question';
            document.querySelector('#addQuestionModal .modal-title').textContent = 'Add New Question';
        }

        // Update the cancel button for question form
        document.getElementById('cancelQuestionBtn').addEventListener('click', function () {
            hideModal('addQuestionModal');
            resetQuestionForm();
        });

        function populateExamsTable(examsData) {
            const tableBody = document.getElementById('examsTableBody');

            if (examsData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">No assessments found</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            examsData.forEach(exam => {
                const program = programs.find(p => p.id === exam.programId);
                const examClass = classes.find(c => c.id === exam.classId);
                const school = schools.find(s => s.id === exam.schoolId);

                // Format dates
                const availableFrom = exam.availableFrom ?
                    (exam.availableFrom.toDate ? exam.availableFrom.toDate() : new Date(exam.availableFrom)).toLocaleDateString() : 'N/A';
                const availableTo = exam.availableTo ?
                    (exam.availableTo.toDate ? exam.availableTo.toDate() : new Date(exam.availableTo)).toLocaleDateString() : 'N/A';

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${exam.title}</td>
            <td>${program ? program.name : 'N/A'}</td>
            <td>${examClass ? examClass.name : 'N/A'}</td>
            <td>${school ? school.name : 'N/A'}</td>
            <td>${exam.duration} mins</td>
            <td>${exam.totalQuestions}</td>
            <td>${availableFrom}</td>
            <td>${availableTo}</td>
            <td>
                <span class="status-badge ${exam.status === 'active' ? 'status-active' :
                        exam.status === 'draft' ? 'status-inactive' :
                            'status-inactive'
                    }">
                    ${exam.status ? exam.status.charAt(0).toUpperCase() + exam.status.slice(1) : 'Draft'}
                </span>
                ${exam.shuffleQuestions ? '<br><small style="color: #666;">🔀 Shuffled</small>' : ''}
                ${exam.allowMultipleAttempts ? `<br><small style="color: #666;">🔄 ${exam.maxAttempts ? exam.maxAttempts + ' attempts' : 'Unlimited'}</small>` : ''}
            </td>
            <td class="action-buttons">
                <button class="action-btn btn-primary btn-sm" onclick="editExam('${exam.id}')">Edit</button>
                <button class="action-btn btn-danger btn-sm" onclick="deleteExam('${exam.id}')">Delete</button>
                <button class="action-btn btn-success btn-sm" onclick="viewExam('${exam.id}')">View</button>
                <button class="action-btn btn-warning btn-sm" onclick="toggleExamStatus('${exam.id}', '${exam.status}')">
                    ${exam.status === 'active' ? 'Deactivate' : 'Activate'}
                </button>
            </td>
        `;
                tableBody.appendChild(row);
            });
        }

        // Edit Exam Functionality
        async function editExam(examId) {
            try {
                const exam = exams.find(e => e.id === examId);
                if (!exam) {
                    showNotification('Assessment not found', 'error');
                    return;
                }

                await loadSchoolsProgramsClasses();

                // Populate the form with existing data
                document.getElementById('examTitle').value = exam.title || '';
                document.getElementById('examProgram').value = exam.programId || '';
                document.getElementById('examClass').value = exam.classId || '';
                document.getElementById('examSchool').value = exam.schoolId || '';
                document.getElementById('examDuration').value = exam.duration || 60;
                document.getElementById('examQuestions').value = exam.totalQuestions || 10;
                document.getElementById('examInstructions').value = exam.instructions || '';

                // Populate new fields
                if (exam.availableFrom) {
                    const fromDate = exam.availableFrom.toDate ? exam.availableFrom.toDate() : new Date(exam.availableFrom);
                    document.getElementById('examAvailableFrom').value = formatDateTimeLocal(fromDate);
                } else {
                    // Set default to current time
                    document.getElementById('examAvailableFrom').value = formatDateTimeLocal(new Date());
                }

                if (exam.availableTo) {
                    const toDate = exam.availableTo.toDate ? exam.availableTo.toDate() : new Date(exam.availableTo);
                    document.getElementById('examAvailableTo').value = formatDateTimeLocal(toDate);
                } else {
                    // Set default to 7 days from now
                    const defaultToDate = new Date();
                    defaultToDate.setDate(defaultToDate.getDate() + 7);
                    document.getElementById('examAvailableTo').value = formatDateTimeLocal(defaultToDate);
                }

                document.getElementById('examShuffleQuestions').checked = exam.shuffleQuestions || false;
                document.getElementById('examAllowMultipleAttempts').checked = exam.allowMultipleAttempts || false;

                // Show/hide max attempts container
                const maxAttemptsContainer = document.getElementById('maxAttemptsContainer');
                if (maxAttemptsContainer) {
                    maxAttemptsContainer.style.display = exam.allowMultipleAttempts ? 'block' : 'none';
                }

                document.getElementById('examMaxAttempts').value = exam.maxAttempts || 3;

                // Store the exam ID for updating
                const saveBtn = document.getElementById('saveExamBtn');
                saveBtn.setAttribute('data-edit-id', examId);
                saveBtn.textContent = 'Update Assessment';

                // Change the modal title
                document.querySelector('#createExamModal .modal-title').textContent = 'Edit Assessment';

                showModal('createExamModal');

            } catch (error) {
                console.error('Error loading assessment data:', error);
                showNotification('Error loading assessment data', 'error');
            }
        }

        // Helper function to format date for datetime-local input
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Delete Exam Functionality
        async function deleteExam(examId) {
            if (confirm('Are you sure you want to delete this assessment? This action cannot be undone and will delete all related results.')) {
                try {
                    // First, check if there are any results for this exam
                    const resultsSnapshot = await db.collection('results')
                        .where('examId', '==', examId)
                        .get();

                    if (!resultsSnapshot.empty) {
                        if (!confirm('This assessment has student results. Deleting it will also remove all results. Are you sure you want to continue?')) {
                            return;
                        }

                        // Delete all related results
                        const batch = db.batch();
                        resultsSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                    }

                    await db.collection('exams').doc(examId).delete();
                    showNotification('Assessment deleted successfully!', 'success');
                    loadExamsData();
                    loadDashboardData();

                } catch (error) {
                    console.error('Error deleting assessment:', error);
                    showNotification('Error deleting assessment. Please try again.', 'error');
                }
            }
        }

        // View Exam Functionality
        async function viewExam(examId) {
            try {
                const exam = exams.find(e => e.id === examId);
                if (!exam) {
                    showNotification('Assessment not found', 'error');
                    return;
                }

                const program = programs.find(p => p.id === exam.programId);
                const examClass = classes.find(c => c.id === exam.classId);
                const school = schools.find(s => s.id === exam.schoolId);

                // Create a view modal or use alert for now (you can create a proper modal later)
                const examDetails = `
Assessment Details:
-------------------
Title: ${exam.title}
Program: ${program ? program.name : 'N/A'}
Class: ${examClass ? examClass.name : 'N/A'}
School: ${school ? school.name : 'N/A'}
Duration: ${exam.duration} minutes
Total Questions: ${exam.totalQuestions}
Status: ${exam.status}
Instructions: ${exam.instructions || 'No instructions provided'}
Created: ${exam.createdAt ? exam.createdAt.toDate().toLocaleString() : 'N/A'}
        `;

                // For now, using alert. You can create a proper modal for this later
                alert(examDetails);

                // Alternatively, you can create a view modal:
                // showExamDetailsModal(exam, program, examClass, school);

            } catch (error) {
                console.error('Error viewing assessment:', error);
                showNotification('Error loading assessment details', 'error');
            }
        }

        // Toggle Exam Status (Activate/Deactivate)
        async function toggleExamStatus(examId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'activate' : 'deactivate';

            if (confirm(`Are you sure you want to ${action} this assessment?`)) {
                try {
                    await db.collection('exams').doc(examId).update({
                        status: newStatus,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showNotification(`Assessment ${action}d successfully!`, 'success');
                    loadExamsData();
                    loadDashboardData();

                } catch (error) {
                    console.error(`Error ${action}ing assessment:`, error);
                    showNotification(`Error ${action}ing assessment. Please try again.`, 'error');
                }
            }
        }

        // Update the saveExam function to handle both create and update
        async function saveExam() {
            const saveBtn = document.getElementById('saveExamBtn');
            const isEdit = saveBtn.hasAttribute('data-edit-id');
            const examId = isEdit ? saveBtn.getAttribute('data-edit-id') : null;

            const formData = {
                title: document.getElementById('examTitle').value,
                programId: document.getElementById('examProgram').value,
                classId: document.getElementById('examClass').value,
                schoolId: document.getElementById('examSchool').value,
                duration: parseInt(document.getElementById('examDuration').value),
                totalQuestions: parseInt(document.getElementById('examQuestions').value),
                instructions: document.getElementById('examInstructions').value,
                availableFrom: new Date(document.getElementById('examAvailableFrom').value),
                availableTo: new Date(document.getElementById('examAvailableTo').value),
                shuffleQuestions: document.getElementById('examShuffleQuestions').checked,
                allowMultipleAttempts: document.getElementById('examAllowMultipleAttempts').checked,
                maxAttempts: document.getElementById('examAllowMultipleAttempts').checked ?
                    (document.getElementById('examMaxAttempts').value ?
                        parseInt(document.getElementById('examMaxAttempts').value) : null) : null,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Validate dates
            if (formData.availableFrom >= formData.availableTo) {
                showNotification('Available To date must be after Available From date', 'error');
                return;
            }

            // For new exams, set status to draft. For edits, keep existing status
            if (isEdit) {
                // Keep the existing status when editing
                const existingExam = exams.find(e => e.id === examId);
                if (existingExam) {
                    formData.status = existingExam.status;
                }
                delete formData.createdAt;
            } else {
                formData.status = 'draft';
                formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                if (isEdit) {
                    await db.collection('exams').doc(examId).update(formData);
                    showNotification('Assessment updated successfully!', 'success');
                } else {
                    await db.collection('exams').add(formData);
                    showNotification('Assessment created successfully!', 'success');
                }

                hideModal('createExamModal');
                resetExamForm();
                loadExamsData();
                loadDashboardData();

            } catch (error) {
                console.error('Error saving assessment:', error);
                showNotification('Error saving assessment. Please try again.', 'error');
            }
        }

        // Add reset function for exam form
        function resetExamForm() {
            document.getElementById('createExamForm').reset();

            // Set default dates
            const now = new Date();
            const oneWeekLater = new Date(now);
            oneWeekLater.setDate(oneWeekLater.getDate() + 7);

            document.getElementById('examAvailableFrom').value = formatDateTimeLocal(now);
            document.getElementById('examAvailableTo').value = formatDateTimeLocal(oneWeekLater);

            // Hide max attempts container
            const maxAttemptsContainer = document.getElementById('maxAttemptsContainer');
            if (maxAttemptsContainer) {
                maxAttemptsContainer.style.display = 'none';
            }

            const saveBtn = document.getElementById('saveExamBtn');
            saveBtn.removeAttribute('data-edit-id');
            saveBtn.textContent = 'Create Assessment';
            document.querySelector('#createExamModal .modal-title').textContent = 'Create Assessment';
        }

        // Update the cancel button for exam form
        document.getElementById('cancelExamBtn').addEventListener('click', function () {
            hideModal('createExamModal');
            resetExamForm();
        });

        // Enhanced view exam function with modal (optional - you can implement this later)
        function showExamDetailsModal(exam, program, examClass, school) {
            // Create a modal for detailed exam view
            const modalHTML = `
        <div id="examDetailsModal" class="modal active">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Assessment Details</h3>
                    <button class="modal-close" onclick="hideModal('examDetailsModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>Title:</strong> ${exam.title}
                        </div>
                        <div>
                            <strong>Status:</strong> 
                            <span class="status-badge ${exam.status === 'active' ? 'status-active' : 'status-inactive'}">
                                ${exam.status}
                            </span>
                        </div>
                        <div>
                            <strong>Program:</strong> ${program ? program.name : 'N/A'}
                        </div>
                        <div>
                            <strong>Class:</strong> ${examClass ? examClass.name : 'N/A'}
                        </div>
                        <div>
                            <strong>School:</strong> ${school ? school.name : 'N/A'}
                        </div>
                        <div>
                            <strong>Duration:</strong> ${exam.duration} minutes
                        </div>
                        <div>
                            <strong>Total Questions:</strong> ${exam.totalQuestions}
                        </div>
                        <div>
                            <strong>Created:</strong> ${exam.createdAt ? exam.createdAt.toDate().toLocaleString() : 'N/A'}
                        </div>
                    </div>
                    ${exam.instructions ? `
                    <div style="margin-top: 15px;">
                        <strong>Instructions:</strong>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 5px;">
                            ${exam.instructions}
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="hideModal('examDetailsModal')">Close</button>
                    <button class="btn btn-primary" onclick="editExam('${exam.id}'); hideModal('examDetailsModal')">Edit</button>
                </div>
            </div>
        </div>
    `;

            // Remove existing modal if any
            const existingModal = document.getElementById('examDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add new modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Update the create exam button event listener to ensure it resets the form
        document.getElementById('createExamBtn').addEventListener('click', function () {
            resetExamForm();
            loadSchoolsProgramsClasses().then(() => {
                showModal('createExamModal');
            });
        });

        // Add event listener for multiple attempts checkbox
        document.addEventListener('DOMContentLoaded', function () {
            const allowMultipleAttempts = document.getElementById('examAllowMultipleAttempts');
            const maxAttemptsContainer = document.getElementById('maxAttemptsContainer');

            if (allowMultipleAttempts && maxAttemptsContainer) {
                allowMultipleAttempts.addEventListener('change', function () {
                    maxAttemptsContainer.style.display = this.checked ? 'block' : 'none';
                });
            }
        });

        function populateSchoolsTable(schoolsData) {
            const tableBody = document.getElementById('schoolsTableBody');

            if (schoolsData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No schools found</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            schoolsData.forEach(school => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${school.name}</td>
                    <td>${school.code}</td>
                    <td>${school.address || '-'}</td>
                    <td>${school.phone || '-'}<br>${school.email || '-'}</td>
                    <td><span class="status-badge ${school.isActive ? 'status-active' : 'status-inactive'}">${school.isActive ? 'Active' : 'Inactive'}</span></td>
                    <td class="action-buttons">
                        <button class="action-btn btn-primary btn-sm">Edit</button>
                        <button class="action-btn btn-danger btn-sm">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Results and Reports
        async function generateReport() {
            const examId = document.getElementById('resultsExam').value;
            const classId = document.getElementById('resultsClass').value;
            const schoolId = document.getElementById('resultsSchool').value;

            if (!examId) {
                showNotification('Please select an assessment to generate report.', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateReportBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            generateBtn.disabled = true;

            try {
                // Get results for the selected exam
                let resultsQuery = db.collection('results').where('examId', '==', examId);

                const resultsSnapshot = await resultsQuery.get();
                const results = resultsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (results.length === 0) {
                    showNotification('No results found for the selected assessment.', 'info');
                    document.getElementById('resultsTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No results found</td></tr>';
                    document.getElementById('performanceChart').innerHTML = '<p style="text-align: center; color: #666;">No data available for chart</p>';
                    return;
                }

                await displayResultsReport(results);
                generatePerformanceChart(results);

                showNotification(`Report generated: ${results.length} result(s) found`, 'success');

            } catch (error) {
                console.error('Error generating report:', error);
                showNotification('Error generating report: ' + error.message, 'error');
            } finally {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        async function displayResultsReport(results) {
            const resultsTableBody = document.getElementById('resultsTableBody');
            resultsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Loading results...</td></tr>';

            let tableHTML = '';

            for (const result of results) {
                try {
                    const studentDoc = await db.collection('users').doc(result.studentId).get();
                    const student = studentDoc.data();

                    if (student) {
                        const percentage = result.totalQuestions > 0 ? ((result.score / result.totalQuestions) * 100) : 0;

                        tableHTML += `
                            <tr>
                                <td>${student.firstName} ${student.lastName}</td>
                                <td>${student.email}</td>
                                <td>${result.score}/${result.totalQuestions}</td>
                                <td>${percentage.toFixed(1)}%</td>
                                <td>${calculateGrade(percentage)}</td>
                                <td>${Math.floor(result.timeSpent / 60)}:${(result.timeSpent % 60).toString().padStart(2, '0')}</td>
                                <td>${result.submittedAt ? result.submittedAt.toDate().toLocaleDateString() : 'N/A'}</td>
                            </tr>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading student data:', error);
                }
            }

            resultsTableBody.innerHTML = tableHTML || '<tr><td colspan="7" style="text-align: center; padding: 20px;">No results found</td></tr>';
        }

        function generatePerformanceChart(results) {
            const chartContainer = document.getElementById('performanceChart');

            // Simple chart implementation
            const gradeCounts = { A: 0, B: 0, C: 0, D: 0, F: 0 };

            results.forEach(result => {
                const percentage = result.totalQuestions > 0 ? ((result.score / result.totalQuestions) * 100) : 0;
                const grade = calculateGrade(percentage);
                gradeCounts[grade]++;
            });

            const total = results.length;
            const chartHTML = `
                <div style="display: flex; height: 100%; align-items: end; gap: 10px; padding: 20px;">
                    ${Object.entries(gradeCounts).map(([grade, count]) => `
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="background: var(--${getGradeColor(grade)}); width: 80%; height: ${(count / total) * 200}px; border-radius: 5px 5px 0 0;"></div>
                            <div style="margin-top: 10px; font-weight: bold;">${grade}</div>
                            <div style="font-size: 0.8em; color: #666;">${count}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            chartContainer.innerHTML = chartHTML;
        }

        function calculateGrade(percentage) {
            // Default grading system
            if (percentage >= 90) return 'A';
            if (percentage >= 80) return 'B';
            if (percentage >= 70) return 'C';
            if (percentage >= 60) return 'D';
            return 'F';
        }

        function getGradeColor(grade) {
            const colors = {
                A: 'success',
                B: 'accent',
                C: 'warning',
                D: 'secondary',
                F: 'danger'
            };
            return colors[grade] || 'danger';
        }

        // Settings
        async function saveGeneralSettings(e) {
            e.preventDefault();
            // Implementation for saving general settings
            showNotification('General settings saved successfully!', 'success');
        }

        async function saveGradingSettings(e) {
            e.preventDefault();
            // Implementation for saving grading settings
            showNotification('Grading system saved successfully!', 'success');
        }

        // Utility Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;

            const bgColors = {
                success: '#28a745',
                error: '#dc3545',
                info: '#17a2b8',
                warning: '#ffc107'
            };

            notification.style.backgroundColor = bgColors[type] || bgColors.info;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 5000);
        }

        function togglePasswordVisibility(inputId) {
            const passwordInput = document.getElementById(inputId);
            const toggleButton = passwordInput.nextElementSibling;
            const icon = toggleButton.querySelector('i');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Edit Instructor Functionality
        async function editInstructor(instructorId) {
            try {
                const instructor = instructors.find(i => i.id === instructorId);
                if (!instructor) {
                    showNotification('Instructor not found', 'error');
                    return;
                }

                await loadSchoolsAndPrograms();

                // Populate the form with existing data
                document.getElementById('instructorFirstName').value = instructor.firstName || '';
                document.getElementById('instructorLastName').value = instructor.lastName || '';
                document.getElementById('instructorEmail').value = instructor.email || '';
                document.getElementById('instructorPassword').value = instructor.password || '';
                document.getElementById('instructorSchool').value = instructor.schoolId || '';

                // Populate programs (multiple selection)
                const programsSelect = document.getElementById('instructorPrograms');
                if (instructor.programs && Array.isArray(instructor.programs)) {
                    Array.from(programsSelect.options).forEach(option => {
                        option.selected = instructor.programs.includes(option.value);
                    });
                }

                // Store the instructor ID for updating
                const saveBtn = document.getElementById('saveInstructorBtn');
                saveBtn.setAttribute('data-edit-id', instructorId);
                saveBtn.textContent = 'Update Instructor';

                // Change the modal title
                document.querySelector('#addInstructorModal .modal-title').textContent = 'Edit Instructor Account';

                showModal('addInstructorModal');

            } catch (error) {
                console.error('Error loading instructor data:', error);
                showNotification('Error loading instructor data', 'error');
            }
        }

        // Edit Student Functionality
        async function editStudent(studentId) {
            try {
                const student = students.find(s => s.id === studentId);
                if (!student) {
                    showNotification('Student not found', 'error');
                    return;
                }

                await loadSchoolsAndClasses();

                // Populate the form with existing data
                document.getElementById('studentFirstName').value = student.firstName || '';
                document.getElementById('studentLastName').value = student.lastName || '';
                document.getElementById('studentEmail').value = student.email || '';
                document.getElementById('studentPassword').value = student.password || '';
                document.getElementById('studentSchool').value = student.schoolId || '';
                document.getElementById('studentClass').value = student.classId || '';

                // Store the student ID for updating
                const saveBtn = document.getElementById('saveStudentBtn');
                saveBtn.setAttribute('data-edit-id', studentId);
                saveBtn.textContent = 'Update Student';

                // Change the modal title
                document.querySelector('#addStudentModal .modal-title').textContent = 'Edit Student Account';

                showModal('addStudentModal');

            } catch (error) {
                console.error('Error loading student data:', error);
                showNotification('Error loading student data', 'error');
            }
        }

        // Update the saveInstructor function to handle both create and update
        async function saveInstructor() {
            const saveBtn = document.getElementById('saveInstructorBtn');
            const isEdit = saveBtn.hasAttribute('data-edit-id');
            const instructorId = isEdit ? saveBtn.getAttribute('data-edit-id') : null;

            const formData = {
                firstName: document.getElementById('instructorFirstName').value,
                lastName: document.getElementById('instructorLastName').value,
                email: document.getElementById('instructorEmail').value,
                schoolId: document.getElementById('instructorSchool').value,
                programs: Array.from(document.getElementById('instructorPrograms').selectedOptions).map(opt => opt.value),
                role: 'instructor',
                isActive: true,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Only include password if it's provided (for edit) or required (for create)
            const password = document.getElementById('instructorPassword').value;
            if (password) {
                formData.password = password;
            }

            if (isEdit) {
                // Remove createdAt for updates
                delete formData.createdAt;
            } else {
                // Add createdAt for new records
                formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                if (isEdit) {
                    await db.collection('users').doc(instructorId).update(formData);
                    showNotification('Instructor updated successfully!', 'success');
                } else {
                    await db.collection('users').add(formData);
                    showNotification('Instructor created successfully!', 'success');
                }

                hideModal('addInstructorModal');
                resetInstructorForm();
                loadInstructorsData();
                loadDashboardData();

            } catch (error) {
                console.error('Error saving instructor:', error);
                showNotification('Error saving instructor. Please try again.', 'error');
            }
        }

        // Update the saveStudent function to handle both create and update
        async function saveStudent() {
            const saveBtn = document.getElementById('saveStudentBtn');
            const isEdit = saveBtn.hasAttribute('data-edit-id');
            const studentId = isEdit ? saveBtn.getAttribute('data-edit-id') : null;

            const formData = {
                firstName: document.getElementById('studentFirstName').value,
                lastName: document.getElementById('studentLastName').value,
                email: document.getElementById('studentEmail').value,
                schoolId: document.getElementById('studentSchool').value,
                classId: document.getElementById('studentClass').value,
                role: 'student',
                isActive: true,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Only include password if it's provided
            const password = document.getElementById('studentPassword').value;
            if (password) {
                formData.password = password;
            }

            if (isEdit) {
                delete formData.createdAt;
            } else {
                formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                if (isEdit) {
                    await db.collection('users').doc(studentId).update(formData);
                    showNotification('Student updated successfully!', 'success');
                } else {
                    await db.collection('users').add(formData);
                    showNotification('Student created successfully!', 'success');
                }

                hideModal('addStudentModal');
                resetStudentForm();
                loadStudentsData();
                loadDashboardData();

            } catch (error) {
                console.error('Error saving student:', error);
                showNotification('Error saving student. Please try again.', 'error');
            }
        }

        // Add reset functions for forms
        function resetInstructorForm() {
            document.getElementById('addInstructorForm').reset();
            const saveBtn = document.getElementById('saveInstructorBtn');
            saveBtn.removeAttribute('data-edit-id');
            saveBtn.textContent = 'Save Instructor';
            document.querySelector('#addInstructorModal .modal-title').textContent = 'Add Instructor Account';
        }

        function resetStudentForm() {
            document.getElementById('addStudentForm').reset();
            const saveBtn = document.getElementById('saveStudentBtn');
            saveBtn.removeAttribute('data-edit-id');
            saveBtn.textContent = 'Save Student';
            document.querySelector('#addStudentModal .modal-title').textContent = 'Add Student Account';
        }

        // Update the cancel buttons to reset forms
        document.getElementById('cancelInstructorBtn').addEventListener('click', function () {
            hideModal('addInstructorModal');
            resetInstructorForm();
        });

        document.getElementById('cancelStudentBtn').addEventListener('click', function () {
            hideModal('addStudentModal');
            resetStudentForm();
        });

        // Delete functionality
        async function deleteInstructor(instructorId) {
            if (confirm('Are you sure you want to delete this instructor? This action cannot be undone.')) {
                try {
                    await db.collection('users').doc(instructorId).delete();
                    showNotification('Instructor deleted successfully!', 'success');
                    loadInstructorsData();
                    loadDashboardData();
                } catch (error) {
                    console.error('Error deleting instructor:', error);
                    showNotification('Error deleting instructor. Please try again.', 'error');
                }
            }
        }

        async function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                try {
                    await db.collection('users').doc(studentId).delete();
                    showNotification('Student deleted successfully!', 'success');
                    loadStudentsData();
                    loadDashboardData();
                } catch (error) {
                    console.error('Error deleting student:', error);
                    showNotification('Error deleting student. Please try again.', 'error');
                }
            }
        }

        // Resource and Announcement Data Loading
        async function loadResourcesData() {
            try {
                const resourcesSnapshot = await db.collection('resources').get();
                resources = resourcesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateResourcesTable(resources);
                populateResourceFilters();
            } catch (error) {
                console.error('Error loading resources:', error);
            }
        }

        async function loadAnnouncementsData() {
            try {
                const announcementsSnapshot = await db.collection('announcements')
                    .orderBy('createdAt', 'desc')
                    .get();
                announcements = announcementsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateAnnouncementsGrid(announcements);
                populateAnnouncementFilters();
            } catch (error) {
                console.error('Error loading announcements:', error);
            }
        }

        // Form Population
        function populateResourceForm() {
            const programSelect = document.getElementById('resourceProgram');
            const classSelect = document.getElementById('resourceClass');

            programSelect.innerHTML = '<option value="">Select Program</option>';
            classSelect.innerHTML = '<option value="">Select Class</option>';

            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = program.name;
                programSelect.appendChild(option);
            });

            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                classSelect.appendChild(option);
            });
        }

        function populateAnnouncementForm() {
            const programSelect = document.getElementById('announcementProgram');
            const classSelect = document.getElementById('announcementClass');

            programSelect.innerHTML = '<option value="">All Programs</option>';
            classSelect.innerHTML = '<option value="">All Classes</option>';

            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = program.name;
                programSelect.appendChild(option);
            });

            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                classSelect.appendChild(option);
            });

            // Set default dates
            const now = new Date();
            const oneWeekLater = new Date(now);
            oneWeekLater.setDate(oneWeekLater.getDate() + 7);

            document.getElementById('announcementStartDate').value = formatDateTimeLocal(now);
            document.getElementById('announcementEndDate').value = formatDateTimeLocal(oneWeekLater);
        }

        // File Upload Handling
        function handleResourceFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const fileInfo = document.getElementById('resourceFileInfo');
                const fileName = document.getElementById('resourceFileName');
                const fileSize = document.getElementById('resourceFileSize');

                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.style.display = 'block';

                // Validate file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('File size must be less than 10MB', 'error');
                    e.target.value = '';
                    fileInfo.style.display = 'none';
                }
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Save Functions
        async function saveResource() {
            const formData = {
                title: document.getElementById('resourceTitle').value,
                description: document.getElementById('resourceDescription').value,
                programId: document.getElementById('resourceProgram').value,
                classId: document.getElementById('resourceClass').value,
                type: document.getElementById('resourceType').value,
                downloadCount: 0,
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentAdmin.userId
            };

            const fileInput = document.getElementById('resourceFile');
            const file = fileInput.files[0];
            const resourceType = document.getElementById('resourceType').value;

            if (resourceType === 'link') {
                formData.externalLink = document.getElementById('resourceLink').value;
                if (!formData.externalLink) {
                    showNotification('Please provide an external link', 'error');
                    return;
                }
            } else if (!file) {
                showNotification('Please select a file to upload', 'error');
                return;
            }

            try {
                if (file) {
                    // Upload file to Firebase Storage
                    const storageRef = firebase.storage().ref();
                    const fileRef = storageRef.child(`resources/${Date.now()}_${file.name}`);
                    const uploadTask = await fileRef.put(file);

                    // Get download URL
                    const downloadURL = await uploadTask.ref.getDownloadURL();
                    formData.fileUrl = downloadURL;
                    formData.fileName = file.name;
                    formData.fileSize = file.size;
                }

                await db.collection('resources').add(formData);
                hideModal('addResourceModal');
                document.getElementById('addResourceForm').reset();
                document.getElementById('resourceFileInfo').style.display = 'none';
                loadResourcesData();
                showNotification('Resource uploaded successfully!', 'success');

            } catch (error) {
                console.error('Error saving resource:', error);
                showNotification('Error uploading resource. Please try again.', 'error');
            }
        }

        async function saveAnnouncement() {
            const startDate = new Date(document.getElementById('announcementStartDate').value);
            const endDate = new Date(document.getElementById('announcementEndDate').value);

            if (startDate >= endDate) {
                showNotification('End date must be after start date', 'error');
                return;
            }

            const formData = {
                title: document.getElementById('announcementTitle').value,
                message: document.getElementById('announcementMessage').value,
                programId: document.getElementById('announcementProgram').value || null,
                classId: document.getElementById('announcementClass').value || null,
                startDate: startDate,
                endDate: endDate,
                priority: document.getElementById('announcementPriority').value,
                notifyStudents: document.getElementById('announcementNotifyStudents').checked,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentAdmin.userId
            };

            try {
                await db.collection('announcements').add(formData);
                hideModal('addAnnouncementModal');
                document.getElementById('addAnnouncementForm').reset();
                loadAnnouncementsData();
                showNotification('Announcement published successfully!', 'success');

                // TODO: Implement student notifications
                if (formData.notifyStudents) {
                    // This would integrate with your notification system
                    showNotification('Students will be notified about this announcement', 'info');
                }

            } catch (error) {
                console.error('Error saving announcement:', error);
                showNotification('Error publishing announcement. Please try again.', 'error');
            }
        }

        // Table and Grid Population
        function populateResourcesTable(resourcesData) {
            const tableBody = document.getElementById('resourcesTableBody');

            if (resourcesData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No resources found</td></tr>';
                initResponsiveTables();
                return;
            }

            tableBody.innerHTML = '';
            resourcesData.forEach(resource => {
                const program = programs.find(p => p.id === resource.programId);
                const resourceClass = classes.find(c => c.id === resource.classId);

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>
                <strong>${resource.title}</strong>
                ${resource.description ? `<br><small style="color: #666;">${resource.description}</small>` : ''}
            </td>
            <td>${program ? program.name : 'All Programs'}</td>
            <td>${resourceClass ? resourceClass.name : 'All Classes'}</td>
            <td>
                <span class="status-badge" style="background: ${getResourceTypeColor(resource.type)}">
                    ${resource.type.toUpperCase()}
                </span>
            </td>
            <td>${resource.fileSize ? formatFileSize(resource.fileSize) : 'N/A'}</td>
            <td>${resource.createdAt ? resource.createdAt.toDate().toLocaleDateString() : 'N/A'}</td>
            <td>${resource.downloadCount || 0}</td>
            <td><span class="status-badge ${resource.isActive ? 'status-active' : 'status-inactive'}">${resource.isActive ? 'Active' : 'Inactive'}</span></td>
            <td class="action-buttons">
                <button class="action-btn btn-primary btn-sm" onclick="editResource('${resource.id}')">Edit</button>
                <button class="action-btn btn-danger btn-sm" onclick="deleteResource('${resource.id}')">Delete</button>
                ${resource.fileUrl ? `<button class="action-btn btn-success btn-sm" onclick="downloadResource('${resource.id}')">Download</button>` : ''}
            </td>
        `;
                tableBody.appendChild(row);
            });
            initResponsiveTables();
        }

        function populateAnnouncementsGrid(announcementsData) {
            const container = document.getElementById('announcementsContainer');

            if (announcementsData.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No announcements found</div>';
                return;
            }

            let gridHTML = '';
            announcementsData.forEach(announcement => {
                const program = programs.find(p => p.id === announcement.programId);
                const announcementClass = classes.find(c => c.id === announcement.classId);
                const isExpired = new Date() > announcement.endDate.toDate();
                const isActive = announcement.status === 'active' && !isExpired;

                gridHTML += `
            <div class="announcement-card" style="
                background: white;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                border-left: 4px solid ${getPriorityColor(announcement.priority)};
            ">
                <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 15px;">
                    <h4 style="margin: 0; flex: 1;">${announcement.title}</h4>
                    <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                        ${isActive ? 'Active' : isExpired ? 'Expired' : 'Inactive'}
                    </span>
                </div>
                <div style="color: #666; margin-bottom: 15px; line-height: 1.5;">
                    ${announcement.message}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; color: #888;">
                    <div>
                        <strong>Audience:</strong> 
                        ${program ? program.name : 'All Programs'} 
                        ${announcementClass ? `> ${announcementClass.name}` : ''}
                    </div>
                    <div>
                        ${announcement.startDate.toDate().toLocaleDateString()} - 
                        ${announcement.endDate.toDate().toLocaleDateString()}
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="action-btn btn-primary btn-sm" onclick="editAnnouncement('${announcement.id}')">Edit</button>
                    <button class="action-btn btn-danger btn-sm" onclick="deleteAnnouncement('${announcement.id}')">Delete</button>
                </div>
            </div>
        `;
            });

            container.innerHTML = gridHTML;
        }

        // Helper functions
        function getResourceTypeColor(type) {
            const colors = {
                'pdf': '#ff6b6b',
                'video': '#4ecdc4',
                'document': '#45b7d1',
                'presentation': '#96ceb4',
                'link': '#feca57'
            };
            return colors[type] || '#6c757d';
        }

        function getPriorityColor(priority) {
            const colors = {
                'low': '#28a745',
                'normal': '#17a2b8',
                'high': '#ffc107',
                'urgent': '#dc3545'
            };
            return colors[priority] || '#6c757d';
        }

        // Filter functions
        function populateResourceFilters() {
            const programSelect = document.getElementById('filterResourceProgram');
            const classSelect = document.getElementById('filterResourceClass');

            programSelect.innerHTML = '<option value="">All Programs</option>';
            classSelect.innerHTML = '<option value="">All Classes</option>';

            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = program.name;
                programSelect.appendChild(option);
            });

            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                classSelect.appendChild(option);
            });
        }

        function populateAnnouncementFilters() {
            const programSelect = document.getElementById('filterAnnouncementProgram');
            const classSelect = document.getElementById('filterAnnouncementClass');

            programSelect.innerHTML = '<option value="">All Programs</option>';
            classSelect.innerHTML = '<option value="">All Classes</option>';

            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = program.name;
                programSelect.appendChild(option);
            });

            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                classSelect.appendChild(option);
            });
        }

        // Update section navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            // Load section-specific data
            switch (sectionId) {
                case 'users':
                    loadUsersData();
                    break;
                case 'programs':
                    loadProgramsData();
                    break;
                case 'questions':
                    loadQuestionsData();
                    resetQuestionSelections();
                    break;
                case 'exams':
                    loadExamsData();
                    break;
                case 'resources': // New section
                    loadResourcesData();
                    break;
                case 'announcements': // New section
                    loadAnnouncementsData();
                    break;
                case 'results':
                    loadResultsData();
                    break;
                case 'settings':
                    loadSettingsData();
                    break;
            }
        }

        // Complete Resource Functions
        async function editResource(resourceId) {
            try {
                // Make sure resources array is populated
                if (!resources || resources.length === 0) {
                    await loadResourcesData();
                }

                const resource = resources.find(r => r.id === resourceId);
                if (!resource) {
                    showNotification('Resource not found', 'error');
                    return;
                }

                await loadSchoolsProgramsClasses();

                // Populate the form with existing data
                document.getElementById('resourceTitle').value = resource.title || '';
                document.getElementById('resourceDescription').value = resource.description || '';
                document.getElementById('resourceProgram').value = resource.programId || '';
                document.getElementById('resourceClass').value = resource.classId || '';
                document.getElementById('resourceType').value = resource.type || '';

                // Handle type-specific fields
                const isLink = resource.type === 'link';
                document.getElementById('resourceFileUpload').style.display = isLink ? 'none' : 'block';
                document.getElementById('resourceLinkInput').style.display = isLink ? 'block' : 'none';

                if (isLink && resource.externalLink) {
                    document.getElementById('resourceLink').value = resource.externalLink;
                }

                // Show existing file info if it's a file resource
                if (!isLink && resource.fileName) {
                    const fileInfo = document.getElementById('resourceFileInfo');
                    const fileName = document.getElementById('resourceFileName');
                    const fileSize = document.getElementById('resourceFileSize');

                    fileName.textContent = resource.fileName;
                    fileSize.textContent = resource.fileSize ? formatFileSize(resource.fileSize) : 'Unknown size';
                    fileInfo.style.display = 'block';

                    // Add a note that existing file will be kept unless changed
                    fileInfo.innerHTML += '<br><small style="color: #666;">Existing file will be kept unless you upload a new one</small>';
                }

                // Store the resource ID for updating
                const saveBtn = document.getElementById('saveResourceBtn');
                saveBtn.setAttribute('data-edit-id', resourceId);
                saveBtn.textContent = 'Update Resource';

                // Change the modal title
                document.querySelector('#addResourceModal .modal-title').textContent = 'Edit Resource';

                showModal('addResourceModal');

            } catch (error) {
                console.error('Error loading resource data:', error);
                showNotification('Error loading resource data', 'error');
            }
        }

        async function deleteResource(resourceId) {
            if (confirm('Are you sure you want to delete this resource? This action cannot be undone.')) {
                try {
                    const resource = resources.find(r => r.id === resourceId);

                    // If it's a file resource, delete from storage first
                    if (resource.fileUrl) {
                        try {
                            const fileRef = firebase.storage().refFromURL(resource.fileUrl);
                            await fileRef.delete();
                        } catch (storageError) {
                            console.warn('Could not delete file from storage:', storageError);
                            // Continue with database deletion even if storage deletion fails
                        }
                    }

                    await db.collection('resources').doc(resourceId).delete();
                    showNotification('Resource deleted successfully!', 'success');
                    loadResourcesData();

                } catch (error) {
                    console.error('Error deleting resource:', error);
                    showNotification('Error deleting resource. Please try again.', 'error');
                }
            }
        }

        async function downloadResource(resourceId) {
            try {
                const resource = resources.find(r => r.id === resourceId);
                if (!resource) {
                    showNotification('Resource not found', 'error');
                    return;
                }

                if (resource.type === 'link') {
                    // For external links, open in new tab
                    window.open(resource.externalLink, '_blank');
                    showNotification('Opening external link...', 'info');
                } else if (resource.fileUrl) {
                    // For file resources, create download link
                    const link = document.createElement('a');
                    link.href = resource.fileUrl;
                    link.download = resource.fileName || 'download';
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Increment download count
                    await db.collection('resources').doc(resourceId).update({
                        downloadCount: firebase.firestore.FieldValue.increment(1),
                        lastDownloaded: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showNotification('Download started!', 'success');

                    // Update the local data
                    loadResourcesData();
                } else {
                    showNotification('No file available for download', 'error');
                }

            } catch (error) {
                console.error('Error downloading resource:', error);
                showNotification('Error downloading resource. Please try again.', 'error');
            }
        }

        // Complete Announcement Functions
        async function editAnnouncement(announcementId) {
            try {
                // Make sure announcements array is populated
                if (!announcements || announcements.length === 0) {
                    await loadAnnouncementsData();
                }

                const announcement = announcements.find(a => a.id === announcementId);
                if (!announcement) {
                    showNotification('Announcement not found', 'error');
                    return;
                }

                await loadSchoolsProgramsClasses();

                // Populate the form with existing data
                document.getElementById('announcementTitle').value = announcement.title || '';
                document.getElementById('announcementMessage').value = announcement.message || '';
                document.getElementById('announcementProgram').value = announcement.programId || '';
                document.getElementById('announcementClass').value = announcement.classId || '';
                document.getElementById('announcementPriority').value = announcement.priority || 'normal';

                // Set dates
                const startDate = announcement.startDate.toDate ? announcement.startDate.toDate() : new Date(announcement.startDate);
                const endDate = announcement.endDate.toDate ? announcement.endDate.toDate() : new Date(announcement.endDate);

                document.getElementById('announcementStartDate').value = formatDateTimeLocal(startDate);
                document.getElementById('announcementEndDate').value = formatDateTimeLocal(endDate);

                document.getElementById('announcementNotifyStudents').checked = false; // Default to false for edits

                // Store the announcement ID for updating
                const saveBtn = document.getElementById('saveAnnouncementBtn');
                saveBtn.setAttribute('data-edit-id', announcementId);
                saveBtn.textContent = 'Update Announcement';

                // Change the modal title
                document.querySelector('#addAnnouncementModal .modal-title').textContent = 'Edit Announcement';

                showModal('addAnnouncementModal');

            } catch (error) {
                console.error('Error loading announcement data:', error);
                showNotification('Error loading announcement data', 'error');
            }
        }

        async function deleteAnnouncement(announcementId) {
            if (confirm('Are you sure you want to delete this announcement? This action cannot be undone.')) {
                try {
                    await db.collection('announcements').doc(announcementId).delete();
                    showNotification('Announcement deleted successfully!', 'success');
                    loadAnnouncementsData();

                } catch (error) {
                    console.error('Error deleting announcement:', error);
                    showNotification('Error deleting announcement. Please try again.', 'error');
                }
            }
        }

        // Update the saveResource function to handle both create and update
        async function saveResource() {
            const saveBtn = document.getElementById('saveResourceBtn');
            const isEdit = saveBtn.hasAttribute('data-edit-id');
            const resourceId = isEdit ? saveBtn.getAttribute('data-edit-id') : null;

            const formData = {
                title: document.getElementById('resourceTitle').value,
                description: document.getElementById('resourceDescription').value,
                programId: document.getElementById('resourceProgram').value,
                classId: document.getElementById('resourceClass').value,
                type: document.getElementById('resourceType').value,
                isActive: true,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            const fileInput = document.getElementById('resourceFile');
            const file = fileInput.files[0];
            const resourceType = document.getElementById('resourceType').value;

            // Validate inputs
            if (resourceType === 'link') {
                formData.externalLink = document.getElementById('resourceLink').value;
                if (!formData.externalLink) {
                    showNotification('Please provide an external link', 'error');
                    return;
                }
                // Clear file-related fields for link resources
                delete formData.fileUrl;
                delete formData.fileName;
                delete formData.fileSize;
            } else if (!file && !isEdit) {
                // Only require file for new resources (existing ones keep their file)
                showNotification('Please select a file to upload', 'error');
                return;
            }

            try {
                // Handle file upload for new files
                if (file) {
                    // Upload file to Firebase Storage
                    const storageRef = firebase.storage().ref();
                    const fileRef = storageRef.child(`resources/${Date.now()}_${file.name}`);
                    const uploadTask = await fileRef.put(file);

                    // Get download URL
                    const downloadURL = await uploadTask.ref.getDownloadURL();
                    formData.fileUrl = downloadURL;
                    formData.fileName = file.name;
                    formData.fileSize = file.size;

                    // Delete old file if editing and file type changed
                    if (isEdit) {
                        const oldResource = resources.find(r => r.id === resourceId);
                        if (oldResource && oldResource.fileUrl && oldResource.type !== 'link') {
                            try {
                                const oldFileRef = firebase.storage().refFromURL(oldResource.fileUrl);
                                await oldFileRef.delete();
                            } catch (storageError) {
                                console.warn('Could not delete old file from storage:', storageError);
                            }
                        }
                    }
                } else if (isEdit && resourceType === 'link') {
                    // If changing from file to link, delete the old file
                    const oldResource = resources.find(r => r.id === resourceId);
                    if (oldResource && oldResource.fileUrl) {
                        try {
                            const oldFileRef = firebase.storage().refFromURL(oldResource.fileUrl);
                            await oldFileRef.delete();
                        } catch (storageError) {
                            console.warn('Could not delete old file from storage:', storageError);
                        }
                    }
                }

                // For edits, keep existing download count, for new set to 0
                if (isEdit) {
                    const oldResource = resources.find(r => r.id === resourceId);
                    formData.downloadCount = oldResource.downloadCount || 0;
                    delete formData.createdAt;
                } else {
                    formData.downloadCount = 0;
                    formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    formData.createdBy = currentAdmin.userId;
                }

                if (isEdit) {
                    await db.collection('resources').doc(resourceId).update(formData);
                    showNotification('Resource updated successfully!', 'success');
                } else {
                    await db.collection('resources').add(formData);
                    showNotification('Resource uploaded successfully!', 'success');
                }

                hideModal('addResourceModal');
                resetResourceForm();
                loadResourcesData();

            } catch (error) {
                console.error('Error saving resource:', error);
                showNotification('Error uploading resource. Please try again.', 'error');
            }
        }

        // Update the saveAnnouncement function to handle both create and update
        async function saveAnnouncement() {
            const saveBtn = document.getElementById('saveAnnouncementBtn');
            const isEdit = saveBtn.hasAttribute('data-edit-id');
            const announcementId = isEdit ? saveBtn.getAttribute('data-edit-id') : null;

            const startDate = new Date(document.getElementById('announcementStartDate').value);
            const endDate = new Date(document.getElementById('announcementEndDate').value);

            if (startDate >= endDate) {
                showNotification('End date must be after start date', 'error');
                return;
            }

            const formData = {
                title: document.getElementById('announcementTitle').value,
                message: document.getElementById('announcementMessage').value,
                programId: document.getElementById('announcementProgram').value || null,
                classId: document.getElementById('announcementClass').value || null,
                startDate: startDate,
                endDate: endDate,
                priority: document.getElementById('announcementPriority').value,
                status: 'active',
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Only set notifyStudents for new announcements
            if (!isEdit) {
                formData.notifyStudents = document.getElementById('announcementNotifyStudents').checked;
            }

            try {
                if (isEdit) {
                    await db.collection('announcements').doc(announcementId).update(formData);
                    showNotification('Announcement updated successfully!', 'success');
                } else {
                    formData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    formData.createdBy = currentAdmin.userId;
                    await db.collection('announcements').add(formData);
                    showNotification('Announcement published successfully!', 'success');

                    // Notify students for new announcements if requested
                    if (formData.notifyStudents) {
                        // This would integrate with your notification system
                        showNotification('Students will be notified about this announcement', 'info');
                    }
                }

                hideModal('addAnnouncementModal');
                resetAnnouncementForm();
                loadAnnouncementsData();

            } catch (error) {
                console.error('Error saving announcement:', error);
                showNotification('Error publishing announcement. Please try again.', 'error');
            }
        }

        // Add reset functions for the forms
        function resetResourceForm() {
            document.getElementById('addResourceForm').reset();
            document.getElementById('resourceFileInfo').style.display = 'none';
            document.getElementById('resourceFileUpload').style.display = 'block';
            document.getElementById('resourceLinkInput').style.display = 'none';

            const saveBtn = document.getElementById('saveResourceBtn');
            saveBtn.removeAttribute('data-edit-id');
            saveBtn.textContent = 'Save Resource';
            document.querySelector('#addResourceModal .modal-title').textContent = 'Add Learning Resource';
        }

        function resetAnnouncementForm() {
            document.getElementById('addAnnouncementForm').reset();

            // Set default dates
            const now = new Date();
            const oneWeekLater = new Date(now);
            oneWeekLater.setDate(oneWeekLater.getDate() + 7);

            document.getElementById('announcementStartDate').value = formatDateTimeLocal(now);
            document.getElementById('announcementEndDate').value = formatDateTimeLocal(oneWeekLater);

            const saveBtn = document.getElementById('saveAnnouncementBtn');
            saveBtn.removeAttribute('data-edit-id');
            saveBtn.textContent = 'Publish Announcement';
            document.querySelector('#addAnnouncementModal .modal-title').textContent = 'Create Announcement';
        }

        // Update the cancel buttons to use reset functions
        document.getElementById('cancelResourceBtn').addEventListener('click', function () {
            hideModal('addResourceModal');
            resetResourceForm();
        });

        document.getElementById('cancelAnnouncementBtn').addEventListener('click', function () {
            hideModal('addAnnouncementModal');
            resetAnnouncementForm();
        });

        // Update the create buttons to ensure forms are reset
        document.getElementById('addResourceBtn').addEventListener('click', function () {
            resetResourceForm();
            loadSchoolsProgramsClasses().then(() => {
                showModal('addResourceModal');
            });
        });

        document.getElementById('addAnnouncementBtn').addEventListener('click', function () {
            resetAnnouncementForm();
            loadSchoolsProgramsClasses().then(() => {
                showModal('addAnnouncementModal');
            });
        });

        // Add toggle status functionality for resources
        async function toggleResourceStatus(resourceId) {
            try {
                const resource = resources.find(r => r.id === resourceId);
                if (!resource) {
                    showNotification('Resource not found', 'error');
                    return;
                }

                const newStatus = !resource.isActive;
                const action = newStatus ? 'activate' : 'deactivate';

                if (confirm(`Are you sure you want to ${action} this resource?`)) {
                    await db.collection('resources').doc(resourceId).update({
                        isActive: newStatus,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showNotification(`Resource ${action}d successfully!`, 'success');
                    loadResourcesData();
                }
            } catch (error) {
                console.error(`Error ${action}ing resource:`, error);
                showNotification(`Error ${action}ing resource. Please try again.`, 'error');
            }
        }

        // Add toggle status functionality for announcements
        async function toggleAnnouncementStatus(announcementId) {
            try {
                const announcement = announcements.find(a => a.id === announcementId);
                if (!announcement) {
                    showNotification('Announcement not found', 'error');
                    return;
                }

                const newStatus = announcement.status === 'active' ? 'inactive' : 'active';
                const action = newStatus === 'active' ? 'activate' : 'deactivate';

                if (confirm(`Are you sure you want to ${action} this announcement?`)) {
                    await db.collection('announcements').doc(announcementId).update({
                        status: newStatus,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showNotification(`Announcement ${action}d successfully!`, 'success');
                    loadAnnouncementsData();
                }
            } catch (error) {
                console.error(`Error ${action}ing announcement:`, error);
                showNotification(`Error ${action}ing announcement. Please try again.`, 'error');
            }
        }

        // Update the resources table to include status toggle
        function populateResourcesTable(resourcesData) {
            const tableBody = document.getElementById('resourcesTableBody');

            if (resourcesData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">No resources found</td></tr>';
                initResponsiveTables();
                return;
            }

            tableBody.innerHTML = '';
            resourcesData.forEach(resource => {
                const program = programs.find(p => p.id === resource.programId);
                const resourceClass = classes.find(c => c.id === resource.classId);

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>
                <strong>${resource.title}</strong>
                ${resource.description ? `<br><small style="color: #666;">${resource.description}</small>` : ''}
            </td>
            <td>${program ? program.name : 'All Programs'}</td>
            <td>${resourceClass ? resourceClass.name : 'All Classes'}</td>
            <td>
                <span class="status-badge" style="background: ${getResourceTypeColor(resource.type)}">
                    ${resource.type.toUpperCase()}
                </span>
            </td>
            <td>${resource.fileSize ? formatFileSize(resource.fileSize) : 'N/A'}</td>
            <td>${resource.createdAt ? resource.createdAt.toDate().toLocaleDateString() : 'N/A'}</td>
            <td>${resource.downloadCount || 0}</td>
            <td>
                <span class="status-badge ${resource.isActive ? 'status-active' : 'status-inactive'}">
                    ${resource.isActive ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td class="action-buttons">
                <button class="action-btn btn-primary btn-sm" onclick="editResource('${resource.id}')">Edit</button>
                <button class="action-btn btn-danger btn-sm" onclick="deleteResource('${resource.id}')">Delete</button>
                <button class="action-btn btn-warning btn-sm" onclick="toggleResourceStatus('${resource.id}')">
                    ${resource.isActive ? 'Deactivate' : 'Activate'}
                </button>
                ${resource.fileUrl || resource.type === 'link' ?
                        `<button class="action-btn btn-success btn-sm" onclick="downloadResource('${resource.id}')">
                        ${resource.type === 'link' ? 'Open Link' : 'Download'}
                    </button>` : ''}
            </td>
        `;
                tableBody.appendChild(row);
            });
            initResponsiveTables();
        }

        // Update the announcements grid to include status toggle
        function populateAnnouncementsGrid(announcementsData) {
            const container = document.getElementById('announcementsContainer');

            if (announcementsData.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No announcements found</div>';
                return;
            }

            let gridHTML = '';
            announcementsData.forEach(announcement => {
                const program = programs.find(p => p.id === announcement.programId);
                const announcementClass = classes.find(c => c.id === announcement.classId);
                const isExpired = new Date() > (announcement.endDate.toDate ? announcement.endDate.toDate() : new Date(announcement.endDate));
                const isActive = announcement.status === 'active' && !isExpired;

                gridHTML += `
            <div class="announcement-card" style="
                background: white;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                border-left: 4px solid ${getPriorityColor(announcement.priority)};
            ">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <h4 style="margin: 0; flex: 1;">${announcement.title}</h4>
                    <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                        ${isActive ? 'Active' : isExpired ? 'Expired' : 'Inactive'}
                    </span>
                </div>
                <div style="color: #666; margin-bottom: 15px; line-height: 1.5; white-space: pre-wrap;">
                    ${announcement.message}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; color: #888; margin-bottom: 15px;">
                    <div>
                        <strong>Audience:</strong> 
                        ${program ? program.name : 'All Programs'} 
                        ${announcementClass ? `> ${announcementClass.name}` : ''}
                    </div>
                    <div>
                        ${(announcement.startDate.toDate ? announcement.startDate.toDate() : new Date(announcement.startDate)).toLocaleDateString()} - 
                        ${(announcement.endDate.toDate ? announcement.endDate.toDate() : new Date(announcement.endDate)).toLocaleDateString()}
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="action-btn btn-primary btn-sm" onclick="editAnnouncement('${announcement.id}')">Edit</button>
                    <button class="action-btn btn-danger btn-sm" onclick="deleteAnnouncement('${announcement.id}')">Delete</button>
                    <button class="action-btn btn-warning btn-sm" onclick="toggleAnnouncementStatus('${announcement.id}')">
                        ${announcement.status === 'active' ? 'Deactivate' : 'Activate'}
                    </button>
                </div>
            </div>
        `;
            });

            container.innerHTML = gridHTML;
        }



    </script>
</body>

</html>